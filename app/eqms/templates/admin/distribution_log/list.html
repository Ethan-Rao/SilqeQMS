{% extends "_layout.html" %}
{% block title %}Distribution Log{% endblock %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h1 style="margin-top:0;">Distribution Log</h1>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="button button--secondary" href="{{ url_for('admin.index') }}">← Back</a>
        <a class="button button--secondary" href="{{ url_for('rep_traceability.distribution_log_import_get') }}">Import CSV</a>
        <a class="button button--secondary" href="{{ export_url }}">Export</a>
        <a class="button" href="{{ url_for('rep_traceability.distribution_log_new_get') }}">+ New Entry</a>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <form class="form" method="get" action="{{ url_for('rep_traceability.distribution_log_list') }}" style="max-width:none;">
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
        <div>
          <div class="label">Date from</div>
          <input type="date" name="date_from" value="{{ filters.date_from|e }}" />
        </div>
        <div>
          <div class="label">Date to</div>
          <input type="date" name="date_to" value="{{ filters.date_to|e }}" />
        </div>
        <div>
          <div class="label">Source</div>
          <select name="source" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Sources</option>
            <option value="shipstation" {% if filters.source == "shipstation" %}selected{% endif %}>ShipStation</option>
            <option value="manual" {% if filters.source == "manual" %}selected{% endif %}>Manual</option>
            <option value="csv_import" {% if filters.source == "csv_import" %}selected{% endif %}>CSV Import</option>
          </select>
        </div>
        <div>
          <div class="label">Rep</div>
          <select name="rep_id" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Reps</option>
            {% for r in reps or [] %}
              <option value="{{ r.id }}" {% if filters.rep_id == r.id|string %}selected{% endif %}>{{ r.email }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <div class="label">SKU</div>
          <select name="sku" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All SKUs</option>
            <option value="211410SPT" {% if filters.sku == "211410SPT" %}selected{% endif %}>211410SPT (14Fr)</option>
            <option value="211610SPT" {% if filters.sku == "211610SPT" %}selected{% endif %}>211610SPT (16Fr)</option>
            <option value="211810SPT" {% if filters.sku == "211810SPT" %}selected{% endif %}>211810SPT (18Fr)</option>
          </select>
        </div>
        <div>
          <div class="label">Search</div>
          <input name="q" placeholder="Facility name..." value="{{ filters.q|e }}" />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="button" type="submit">Apply</button>
        <a class="button button--secondary" href="{{ url_for('rep_traceability.distribution_log_list') }}">Clear</a>
      </div>
    </form>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    {% if entries %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Date</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Order</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Facility</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">SKU</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Lot</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Qty</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Source</th>
              <th style="text-align:center; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for e in entries %}
              <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                <td style="padding:10px 12px; font-size:13px;">{{ e.ship_date }}</td>
                <td style="padding:10px 12px;"><code style="font-size:12px;">{{ e.order_number|e }}</code></td>
                <td style="padding:10px 12px;">
                  {% if e.customer %}
                    <a href="{{ url_for('customer_profiles.customer_detail', customer_id=e.customer.id) }}" style="font-weight:500;">{{ e.customer.facility_name|e }}</a>
                  {% else %}
                    {{ e.facility_name|e }}
                  {% endif %}
                </td>
                <td style="padding:10px 12px;"><code style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:12px;">{{ e.sku|e }}</code></td>
                <td style="padding:10px 12px;"><code style="font-size:12px;">{{ e.lot_number|e }}</code></td>
                <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ e.quantity }}</td>
                <td style="padding:10px 12px;">
                  {% if e.source == 'shipstation' %}
                    <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">ShipStation</span>
                  {% elif e.source == 'manual' %}
                    <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">Manual</span>
                  {% elif e.source == 'csv_import' %}
                    <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(61,220,151,0.15); color:var(--success);">CSV</span>
                  {% else %}
                    <span style="font-size:11px;">{{ e.source|e }}</span>
                  {% endif %}
                </td>
                <td style="padding:10px 12px; text-align:center; white-space:nowrap;">
                  <button class="button button--secondary" style="font-size:11px; padding:4px 8px; margin-right:4px;" onclick="showEntryDetails({{ e.id }})">Details</button>
                  <a href="{{ url_for('rep_traceability.distribution_log_edit_get', entry_id=e.id) }}" style="font-size:12px; padding:4px 8px;">Edit</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div style="text-align:center; padding:40px 20px;">
        <p class="muted" style="margin:0 0 12px 0;">No entries match the current filters.</p>
        <a class="button button--secondary" href="{{ url_for('rep_traceability.distribution_log_list') }}">Clear Filters</a>
      </div>
    {% endif %}
  </div>

  <div style="height: 14px;"></div>
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div class="muted" style="font-size:12px;">
      Showing {{ ((page - 1) * per_page) + 1 }}–{{ [page * per_page, total]|min }} of {{ total }} entries
    </div>
    <div style="display:flex; gap:10px;">
      {% if has_prev %}
        <a class="button button--secondary" style="font-size:12px; padding:6px 12px;" href="{{ prev_url }}">← Previous</a>
      {% endif %}
      {% if has_next %}
        <a class="button button--secondary" style="font-size:12px; padding:6px 12px;" href="{{ next_url }}">Next →</a>
      {% endif %}
    </div>
  </div>

  <!-- Entry Details Modal -->
  <dialog id="entry-details-modal" style="max-width:700px; width:90%; padding:0; border-radius:12px; border:1px solid var(--border); background:var(--card-bg); color:var(--text); box-shadow:0 8px 32px rgba(0,0,0,0.3);">
    <div style="padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--card-bg);">
      <h2 style="margin:0; font-size:18px; font-weight:600;">Distribution Details</h2>
      <button onclick="document.getElementById('entry-details-modal').close()" style="background:none; border:none; font-size:28px; cursor:pointer; color:var(--muted); line-height:1; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">&times;</button>
    </div>
    <div id="entry-details-content" style="padding:24px; max-height:calc(80vh - 120px); overflow-y:auto; overflow-x:hidden;">
      <div class="muted" style="text-align:center; padding:20px;">Loading...</div>
    </div>
    <div style="padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:flex-end;">
      <button class="button button--secondary" onclick="document.getElementById('entry-details-modal').close()">Close</button>
    </div>
  </dialog>

  <style>
    #entry-details-modal::backdrop {
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(2px);
    }
    #entry-details-modal section {
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid var(--border);
    }
    #entry-details-modal section:last-child {
      border-bottom:none;
      margin-bottom:0;
    }
    #entry-details-modal .section-header {
      font-size:14px;
      font-weight:600;
      margin-bottom:12px;
      color:var(--text);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }
    #entry-details-modal .field-label {
      font-size:12px;
      color:var(--muted);
      margin-bottom:4px;
      display:block;
    }
    #entry-details-modal .field-value {
      font-size:14px;
      line-height:1.6;
      margin-bottom:12px;
      color:var(--text);
      word-wrap:break-word;
    }
  </style>

  <script>
  async function showEntryDetails(entryId) {
    const modal = document.getElementById('entry-details-modal');
    const content = document.getElementById('entry-details-content');
    content.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">Loading...</div>';
    modal.showModal();
    
    try {
      const response = await fetch(`/admin/distribution-log/entry-details/${entryId}`);
      const data = await response.json();
      
      if (data.error) {
        content.innerHTML = `<div style="color:var(--danger); text-align:center; padding:20px;">${data.error}</div>`;
        return;
      }
      
      let html = `
        <section>
          <div class="section-header">Distribution Entry</div>
          <div style="display:grid; grid-template-columns: auto 1fr; gap:4px 12px;">
            <div class="field-label">Ship Date</div><div class="field-value">${data.entry.ship_date || '—'}</div>
            <div class="field-label">Order #</div><div class="field-value"><code>${data.entry.order_number || '—'}</code></div>
            <div class="field-label">SKU</div><div class="field-value"><code style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px;">${data.entry.sku}</code></div>
            <div class="field-label">Lot</div><div class="field-value"><code>${data.entry.lot_number || '—'}</code></div>
            <div class="field-label">Quantity</div><div class="field-value" style="font-weight:600;">${data.entry.quantity}</div>
            <div class="field-label">Source</div><div class="field-value">${data.entry.source}</div>
          </div>
        </section>
      `;
      
      if (data.order) {
        html += `
          <section>
            <div class="section-header">Linked Sales Order</div>
            <div style="display:grid; grid-template-columns: auto 1fr; gap:4px 12px;">
              <div class="field-label">Order #</div><div class="field-value"><strong>${data.order.order_number}</strong></div>
              <div class="field-label">Order Date</div><div class="field-value">${data.order.order_date || '—'}</div>
              <div class="field-label">Status</div><div class="field-value">${data.order.status || '—'}</div>
            </div>
          </section>
        `;
      }
      
      if (data.customer) {
        html += `
          <section>
            <div class="section-header">Customer</div>
            <div style="margin-bottom:8px;">
              <a href="/admin/customers/${data.customer.id}" style="font-weight:600; font-size:15px;">${data.customer.facility_name}</a>
              <span class="muted" style="font-size:12px; margin-left:8px;">${data.customer.city || ''} ${data.customer.state || ''}</span>
            </div>
        `;
        
        if (data.customer_stats) {
          html += `
            <div class="section-header" style="margin-top:12px;">Customer Stats</div>
            <div style="display:grid; grid-template-columns: auto 1fr; gap:4px 12px; font-size:13px;">
              <div class="field-label">First Order</div><div class="field-value">${data.customer_stats.first_order || '—'}</div>
              <div class="field-label">Last Order</div><div class="field-value">${data.customer_stats.last_order || '—'}</div>
              <div class="field-label">Total Orders</div><div class="field-value" style="font-weight:600;">${data.customer_stats.total_orders}</div>
              <div class="field-label">Total Units</div><div class="field-value" style="font-weight:600;">${data.customer_stats.total_units}</div>
            </div>
          `;
          
          if (data.customer_stats.top_skus && data.customer_stats.top_skus.length > 0) {
            html += `<div style="margin-top:12px; font-size:11px; text-transform:uppercase; color:var(--muted);">Top SKUs</div>`;
            html += `<div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">`;
            for (const sku of data.customer_stats.top_skus) {
              html += `<span style="font-size:12px; padding:2px 8px; background:rgba(255,255,255,0.05); border-radius:4px;"><code>${sku.sku}</code>: ${sku.units}</span>`;
            }
            html += `</div>`;
          }
          
          if (data.customer_stats.recent_lots && data.customer_stats.recent_lots.length > 0) {
            html += `<div style="margin-top:12px; font-size:11px; text-transform:uppercase; color:var(--muted);">Recent Lots</div>`;
            html += `<div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">`;
            for (const lot of data.customer_stats.recent_lots) {
              html += `<code style="font-size:11px; padding:2px 6px; background:rgba(255,255,255,0.05); border-radius:4px;">${lot}</code>`;
            }
            html += `</div>`;
          }
          if (data.customer_stats.assigned_reps && data.customer_stats.assigned_reps.length > 0) {
            html += `<div style="margin-top:12px; font-size:11px; text-transform:uppercase; color:var(--muted);">Assigned Reps</div>`;
            html += `<div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:4px;">`;
            for (const rep of data.customer_stats.assigned_reps) {
              html += `<span style="font-size:11px; padding:2px 6px; background:rgba(255,255,255,0.05); border-radius:4px;">${rep}</span>`;
            }
            html += `</div>`;
          }
        }

        if (data.attachments && data.attachments.length > 0) {
          html += `<div style="margin-top:16px; padding-top:12px; border-top:1px dashed var(--border);">`;
          html += `<div class="section-header">Attachments</div>`;
          html += `<div style="display:flex; flex-direction:column; gap:6px;">`;
          for (const a of data.attachments) {
            html += `<div style="display:flex; justify-content:space-between; align-items:center; padding:6px 8px; border:1px solid var(--border); border-radius:8px;">
              <div style="font-size:13px;">${a.filename} <span class="muted" style="font-size:11px;">(${a.pdf_type})</span></div>
              <a class="button button--secondary" style="font-size:11px; padding:4px 8px;" href="/admin/sales-orders/pdf/${a.id}/download">Download</a>
            </div>`;
          }
          html += `</div></div>`;
        }
        
        html += `
            <div style="margin-top:16px; padding-top:12px; border-top:1px dashed var(--border);">
              <div class="section-header">Notes</div>
              <form id="note-form-modal" onsubmit="return submitModalNote(event, ${data.customer.id});">
                <div style="display:flex; flex-direction:column; gap:8px;">
                  <div>
                    <span class="field-label">Note</span>
                    <input name="note_text" placeholder="Enter note..." required />
                  </div>
                  <div>
                    <span class="field-label">Date</span>
                    <input type="date" name="note_date" />
                  </div>
                  <button class="button button--secondary" type="submit" style="width:fit-content;">Save Note</button>
                </div>
              </form>
            </div>
          </section>`;
      }
      
      html += `
        <section>
          <div class="section-header">Quick Actions</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            ${data.customer ? `<a href="/admin/customers/${data.customer.id}" class="button button--secondary" style="font-size:12px;">View Customer Profile</a>` : ''}
            ${data.customer ? `<button class="button button--secondary" style="font-size:12px;" onclick="openNotesModal('customer', ${data.customer.id})">View Notes</button>` : ''}
            <a href="/admin/distribution-log/${data.entry.id}/edit" class="button button--secondary" style="font-size:12px;">Edit Entry</a>
          </div>
        </section>
      `;
      
      content.innerHTML = html;
    } catch (e) {
      content.innerHTML = `<div style="color:var(--danger); text-align:center; padding:20px;">Error loading details</div>`;
    }
  }

  async function submitModalNote(event, customerId) {
    event.preventDefault();
    const form = event.target;
    const payload = {
      customer_id: customerId,
      note_text: form.note_text.value,
      note_date: form.note_date.value,
    };
    const resp = await fetch(`/admin/sales-dashboard/order-note`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': getCsrfToken() },
      body: JSON.stringify(payload),
    });
    if (resp.ok) {
      form.reset();
      alert('Note saved.');
    } else {
      alert('Failed to save note.');
    }
    return false;
  }

  function getCsrfToken() {
    const meta = document.querySelector('meta[name=\"csrf-token\"]');
    return meta ? meta.getAttribute('content') : '';
  }
  
  // Close modal on backdrop click
  document.getElementById('entry-details-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      this.close();
    }
  });
  document.getElementById('entry-details-modal').addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      this.close();
    }
  });
  </script>
{% endblock %}
