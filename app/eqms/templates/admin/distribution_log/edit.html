{% extends "_layout.html" %}
{% if entry %}{% set page_title = "Edit Distribution Entry" %}{% else %}{% set page_title = "New Distribution Entry" %}{% endif %}
{% block title %}{{ page_title }}{% endblock %}
{% block content %}
  <div class="card">
    <h1 style="margin-top:0;">{{ page_title }}</h1>
    <p class="muted">P0: manual entry and edits. For edits, a reason-for-change is required.</p>

    {% if entry %}
      <form class="form" method="post" action="{{ url_for('rep_traceability.distribution_log_edit_post', entry_id=entry.id) }}">
    {% else %}
      <form class="form" method="post" action="{{ url_for('rep_traceability.distribution_log_new_post') }}">
    {% endif %}
      <div>
        <div class="label">Ship Date *</div>
        <input type="date" name="ship_date" required value="{% if entry %}{{ entry.ship_date }}{% endif %}" />
      </div>
      <div>
        <div class="label">Order Number</div>
        <input name="order_number" value="{% if entry %}{{ entry.order_number|e }}{% endif %}" placeholder="Leave blank to auto-generate" />
      </div>
      <div>
        <div class="label">Customer *</div>
        <select name="customer_id" id="customer_select" required>
          <option value="">— Select Customer —</option>
          {% for c in (customers or []) %}
            <option value="{{ c.id }}" 
                    data-facility="{{ c.facility_name|e }}"
                    data-city="{{ c.city|e if c.city else '' }}"
                    data-state="{{ c.state|e if c.state else '' }}"
                    data-zip="{{ c.zip|e if c.zip else '' }}"
                    {% if entry and entry.customer_id == c.id %}selected{% endif %}>
              {{ c.facility_name|e }}{% if c.state %} ({{ c.state|e }}){% endif %}
            </option>
          {% endfor %}
        </select>
        <div class="muted" style="margin-top:6px;">Customer selection is required for data cohesion. Facility/address fields will be auto-filled from customer profile.</div>
      </div>

      <div>
        <div class="label">Sales Order (optional - link to existing order)</div>
        <select name="sales_order_id" id="sales_order_select">
          <option value="">— No Sales Order / Create New —</option>
          {% for o in (sales_orders or []) %}
            <option value="{{ o.id }}" {% if entry and entry.sales_order_id == o.id %}selected{% endif %}>
              {{ o.order_number }} ({{ o.order_date }}) - {{ o.customer.facility_name[:30] if o.customer else 'No Customer' }}
            </option>
          {% endfor %}
        </select>
        <div class="muted" style="margin-top:6px;">Link this distribution to an existing sales order for traceability. Leave blank for standalone entry.</div>
      </div>

      <div>
        <div class="label">Facility Name *</div>
        <input name="facility_name" required value="{% if entry %}{{ entry.facility_name|e }}{% endif %}" />
      </div>

      {% if entry %}
        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
          <div>
            <div class="label">SKU *</div>
            <input name="sku" required value="{% if entry %}{{ entry.sku|e }}{% endif %}" placeholder="211810SPT / 211610SPT / 211410SPT" />
          </div>
          <div>
            <div class="label">Lot Number *</div>
            <input name="lot_number" required value="{% if entry %}{{ entry.lot_number|e }}{% endif %}" placeholder="SLQ-12345" />
          </div>
        </div>

        <div>
          <div class="label">Quantity *</div>
          <input name="quantity" required value="{% if entry %}{{ entry.quantity }}{% endif %}" />
        </div>
      {% else %}
        <div class="label">Items (multiple SKUs supported) *</div>
        <div id="sku-rows">
          <div class="sku-row" data-row="0" style="margin-bottom:10px;">
            <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 40px; gap: 12px; align-items:end;">
              <div>
                <div class="label">SKU *</div>
                <select name="skus[]" required>
                  <option value="">Select SKU</option>
                  <option value="211810SPT">211810SPT (18Fr)</option>
                  <option value="211610SPT">211610SPT (16Fr)</option>
                  <option value="211410SPT">211410SPT (14Fr)</option>
                </select>
              </div>
              <div>
                <div class="label">Lot Number *</div>
                <input name="lots[]" placeholder="SLQ-12345" required />
              </div>
              <div>
                <div class="label">Quantity *</div>
                <input name="quantities[]" type="number" min="1" required />
              </div>
              <div style="display:flex; align-items:flex-end;">
                <button type="button" class="button button--secondary" onclick="removeSkuRow(this)" style="padding:8px 10px;">×</button>
              </div>
            </div>
          </div>
        </div>
        <button type="button" class="button button--secondary" onclick="addSkuRow()">+ Add Another SKU</button>
      {% endif %}

      {% if entry %}
        <div>
          <div class="label">Source *</div>
          <input name="source" required value="{{ entry.source|e }}" />
        </div>
      {% endif %}

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <div class="label">Rep ID</div>
          <input name="rep_id" value="{% if entry and entry.rep_id %}{{ entry.rep_id }}{% endif %}" placeholder="(optional) numeric user id" />
        </div>
        <div>
          <div class="label">Rep Name</div>
          <input name="rep_name" value="{% if entry and entry.rep_name %}{{ entry.rep_name|e }}{% endif %}" placeholder="(optional) display name" />
        </div>
      </div>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <div class="label">City</div>
          <input name="city" value="{% if entry and entry.city %}{{ entry.city|e }}{% endif %}" />
        </div>
        <div>
          <div class="label">State</div>
          <input name="state" value="{% if entry and entry.state %}{{ entry.state|e }}{% endif %}" />
        </div>
      </div>

      <div>
        <div class="label">Zip</div>
        <input name="zip" value="{% if entry and entry.zip %}{{ entry.zip|e }}{% endif %}" />
      </div>

      <div>
        <div class="label">Tracking Number</div>
        <input name="tracking_number" value="{% if entry and entry.tracking_number %}{{ entry.tracking_number|e }}{% endif %}" />
      </div>

      {% if entry %}
        <div>
          <div class="label">Reason (required for edit/delete) *</div>
          <input name="reason" required placeholder="Reason for change" />
        </div>
      {% endif %}

      <div style="display:flex; gap:10px; align-items:center;">
        <button class="button" type="submit">{% if entry %}Save changes{% else %}Save distribution{% endif %}</button>
        <a class="button button--secondary" href="{{ url_for('rep_traceability.distribution_log_list') }}">Cancel</a>
      </div>
    </form>

    {% if entry %}
      <div style="height: 14px;"></div>
      <div class="card">
        <h3 style="margin-top:0;">PDF Attachments</h3>
        {% if entry.attachments %}
          <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
            {% for att in entry.attachments %}
            <div style="display:flex; align-items:center; gap:8px; padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:6px; font-size:13px;">
              <span>{{ att.filename|e }}</span>
              <span class="muted" style="font-size:11px;">{{ att.pdf_type }}</span>
              <a href="{{ url_for('rep_traceability.download_pdf_attachment', attachment_id=att.id) }}" class="button button--secondary" style="font-size:11px; padding:3px 8px;" title="Download">↓ Download</a>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted" style="margin-bottom:12px;">No PDFs attached to this distribution.</p>
        {% endif %}
        <form class="form" method="post" action="{{ url_for('rep_traceability.distribution_upload_pdf', entry_id=entry.id) }}" enctype="multipart/form-data" style="max-width:400px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
          <div class="label">Upload PDF</div>
          <input type="file" name="pdf_file" accept=".pdf" required style="margin-bottom:8px;">
          <button class="button button--secondary" type="submit">Upload PDF</button>
        </form>
      </div>

      <div style="height: 14px;"></div>
      <div class="card">
        <h3 style="margin-top:0;">Delete entry</h3>
        <p class="muted">Deletion is allowed for Admin in P0 (requires reason). This removes the row; audit trail preserves the event.</p>
        <form class="form" method="post" action="{{ url_for('rep_traceability.distribution_log_delete', entry_id=entry.id) }}">
          <div>
            <div class="label">Reason *</div>
            <input name="reason" required placeholder="Reason for deletion" />
          </div>
          <button class="button button--secondary" type="submit">Delete</button>
        </form>
      </div>
    {% endif %}
  </div>

<script>
// Auto-fill facility/address fields when customer is selected
document.getElementById('customer_select')?.addEventListener('change', function() {
    var opt = this.options[this.selectedIndex];
    if (opt.value) {
        var facilityField = document.querySelector('input[name="facility_name"]');
        var cityField = document.querySelector('input[name="city"]');
        var stateField = document.querySelector('input[name="state"]');
        var zipField = document.querySelector('input[name="zip"]');
        
        if (facilityField) facilityField.value = opt.dataset.facility || '';
        if (cityField) cityField.value = opt.dataset.city || '';
        if (stateField) stateField.value = opt.dataset.state || '';
        if (zipField) zipField.value = opt.dataset.zip || '';
    }
});

function addSkuRow() {
    const container = document.getElementById('sku-rows');
    if (!container) return;
    const row = document.createElement('div');
    row.className = 'sku-row';
    row.style.marginBottom = '10px';
    row.innerHTML = `
      <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 40px; gap: 12px; align-items:end;">
        <div>
          <div class="label">SKU *</div>
          <select name="skus[]" required>
            <option value="">Select SKU</option>
            <option value="211810SPT">211810SPT (18Fr)</option>
            <option value="211610SPT">211610SPT (16Fr)</option>
            <option value="211410SPT">211410SPT (14Fr)</option>
          </select>
        </div>
        <div>
          <div class="label">Lot Number *</div>
          <input name="lots[]" placeholder="SLQ-12345" required />
        </div>
        <div>
          <div class="label">Quantity *</div>
          <input name="quantities[]" type="number" min="1" required />
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button type="button" class="button button--secondary" onclick="removeSkuRow(this)" style="padding:8px 10px;">×</button>
        </div>
      </div>
    `;
    container.appendChild(row);
}

function removeSkuRow(btn) {
    const row = btn?.closest('.sku-row');
    if (!row) return;
    const container = document.getElementById('sku-rows');
    if (container && container.children.length > 1) {
        row.remove();
    }
}
</script>
{% endblock %}

