{% extends "_layout.html" %}
{% block title %}New Supplier{% endblock %}
{% block content %}
  <div class="card">
    <h1>New Supplier</h1>

    <div class="card" style="margin-bottom:14px;">
      <h3 style="margin-top:0; font-size:14px;">Quick Fill from PDF</h3>
      <p class="muted" style="font-size:12px;">Upload a Supplier Assessment PDF to auto-fill fields.</p>
      <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
        <input type="file" id="pdf-upload" accept=".pdf" />
        <button type="button" class="button button--secondary" onclick="extractSupplierFromPdf()">Extract Fields</button>
      </div>
      <div id="extract-status" style="margin-top:8px; font-size:12px;"></div>
    </div>

    <form class="form" method="post" action="{{ url_for('suppliers.suppliers_new_post') }}">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div class="label">Name *</div>
          <input name="name" required placeholder="Supplier name" />
        </div>
        <div>
          <div class="label">Status</div>
          <select name="status">
            <option value="Pending" selected>Pending</option>
            <option value="Approved">Approved</option>
            <option value="Conditional">Conditional</option>
            <option value="Rejected">Rejected</option>
          </select>
        </div>
        <div>
          <div class="label">Category</div>
          <input name="category" placeholder="e.g. Component Supplier, Service Provider" />
        </div>
        <div>
          <div class="label">Initial Listing Date</div>
          <input type="date" name="initial_listing_date" />
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Products/Services Provided</div>
          <textarea name="product_service_provided" rows="2" placeholder="Description of products/services..."></textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Address</div>
          <textarea name="address" rows="2" placeholder="Full address..."></textarea>
        </div>
        <div>
          <div class="label">Certification Expiration</div>
          <input type="date" name="certification_expiration" />
        </div>
        <div></div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Notes</div>
          <textarea name="notes" rows="3" placeholder="Optional notes..."></textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Custom Fields (JSON)</div>
          <textarea name="custom_fields" rows="3" placeholder='{"key":"value"}'></textarea>
          <small class="muted">Optional key/value pairs. JSON object only.</small>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="button" type="submit">Create Supplier</button>
        <a class="button button--secondary" href="{{ url_for('suppliers.suppliers_list') }}">Cancel</a>
      </div>
    </form>
  </div>

  <script>
  async function extractSupplierFromPdf() {
    const fileInput = document.getElementById('pdf-upload');
    const status = document.getElementById('extract-status');

    if (!fileInput.files[0]) {
      status.innerHTML = '<span style="color:var(--danger);">Please select a PDF first.</span>';
      return;
    }

    status.innerHTML = '<span style="color:var(--muted);">Extracting...</span>';

    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);

    try {
      const res = await fetch('/admin/suppliers/extract-from-pdf', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: formData,
      });
      const data = await res.json();

      if (data.error) {
        status.innerHTML = `<span style="color:var(--danger);">${data.error}</span>`;
        return;
      }

      const fieldMap = {
        'name': 'name',
        'address': 'address',
        'product_service_provided': 'product_service_provided',
      };

      let filled = 0;
      for (const [extractedField, formField] of Object.entries(fieldMap)) {
        if (data.extracted_fields && data.extracted_fields[extractedField]) {
          const input = document.querySelector(`[name="${formField}"]`);
          if (input && !input.value) {
            input.value = data.extracted_fields[extractedField];
            filled++;
          }
        }
      }

      const notesInput = document.querySelector('[name="notes"]');
      if (notesInput) {
        const notesParts = [];
        for (const key of ["contact_name", "contact_email", "contact_phone"]) {
          if (data.extracted_fields && data.extracted_fields[key]) {
            notesParts.push(`${key.replace("_", " ")}: ${data.extracted_fields[key]}`);
          }
        }
        if (notesParts.length) {
          const existing = notesInput.value ? `${notesInput.value}\n` : "";
          notesInput.value = `${existing}${notesParts.join("\n")}`.trim();
          filled += notesParts.length;
        }
      }

      status.innerHTML = `<span style="color:var(--success);">âœ… Filled ${filled} field(s). Review and save.</span>`;
    } catch (e) {
      status.innerHTML = '<span style="color:var(--danger);">Extraction failed.</span>';
    }
  }
  </script>
{% endblock %}
