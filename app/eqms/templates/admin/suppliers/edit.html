{% extends "_layout.html" %}
{% block title %}Edit Supplier: {{ supplier.name }}{% endblock %}
{% block content %}
  <div class="card">
    <h1>Edit Supplier: {{ supplier.name|e }}</h1>

    <form class="form" method="post" action="{{ url_for('suppliers.supplier_edit_post', supplier_id=supplier.id) }}">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div class="label">Name *</div>
          <input name="name" value="{{ supplier.name|e }}" required placeholder="Supplier name" />
        </div>
        <div>
          <div class="label">Status</div>
          <select name="status">
            <option value="Pending" {{ 'selected' if supplier.status == 'Pending' }}>Pending</option>
            <option value="Approved" {{ 'selected' if supplier.status == 'Approved' }}>Approved</option>
            <option value="Conditional" {{ 'selected' if supplier.status == 'Conditional' }}>Conditional</option>
            <option value="Rejected" {{ 'selected' if supplier.status == 'Rejected' }}>Rejected</option>
          </select>
        </div>
        <div>
          <div class="label">Category</div>
          <input name="category" value="{{ (supplier.category or '')|e }}" placeholder="e.g. Component Supplier, Service Provider" />
        </div>
        <div>
          <div class="label">Initial Listing Date</div>
          <input type="date" name="initial_listing_date" value="{{ supplier.initial_listing_date or '' }}" />
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Products/Services Provided</div>
          <textarea name="product_service_provided" rows="2" placeholder="Description of products/services...">{{ (supplier.product_service_provided or '')|e }}</textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Address</div>
          <textarea name="address" rows="2" placeholder="Full address...">{{ (supplier.address or '')|e }}</textarea>
        </div>
        <div>
          <div class="label">Contact Name</div>
          <input name="contact_name" value="{{ (supplier.contact_name or '')|e }}" placeholder="Primary contact person" />
        </div>
        <div>
          <div class="label">Contact Email</div>
          <input type="email" name="contact_email" value="{{ (supplier.contact_email or '')|e }}" placeholder="contact@example.com" />
        </div>
        <div>
          <div class="label">Contact Phone</div>
          <input name="contact_phone" value="{{ (supplier.contact_phone or '')|e }}" placeholder="(555) 123-4567" />
        </div>
        <div>
          <div class="label">Certification Expiration</div>
          <input type="date" name="certification_expiration" value="{{ supplier.certification_expiration or '' }}" />
        </div>
        <div></div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Notes</div>
          <textarea name="notes" rows="3" placeholder="Optional notes...">{{ (supplier.notes or '')|e }}</textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Reason for Change (required if changing status)</div>
          <input name="reason" placeholder="Why are you making this change?" />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="button" type="submit">Save Changes</button>
        <a class="button button--secondary" href="{{ url_for('suppliers.supplier_detail', supplier_id=supplier.id) }}">Cancel</a>
      </div>
    </form>
  </div>

  <div style="height: 14px;"></div>
  <div class="card">
    <h2 style="margin-top:0; font-size:16px;">Upload Document with Auto-Extract</h2>
    <p class="muted" style="font-size:12px;">Upload a Supplier Assessment PDF and we'll extract field values automatically.</p>

    <form id="smart-upload-form" enctype="multipart/form-data" style="margin-top:12px;">
      <input type="file" id="pdf-upload" name="pdf_file" accept=".pdf" />
      <button type="button" class="button button--secondary" onclick="extractSupplierFromPdf()">Extract Fields</button>
    </form>

    <div id="extracted-preview" style="display:none; margin-top:16px; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px;">
      <h3 style="margin-top:0; font-size:14px;">Extracted Fields (Review & Edit)</h3>
      <div id="extracted-fields"></div>
      <div style="margin-top:12px;">
        <button class="button" type="button" onclick="applySupplierExtracted()">Apply to Form</button>
        <button class="button button--secondary" type="button" onclick="cancelSupplierExtract()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  let extractedSupplierData = {};

  async function extractSupplierFromPdf() {
    const fileInput = document.getElementById('pdf-upload');
    if (!fileInput.files[0]) {
      alert('Please select a PDF file first.');
      return;
    }

    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);

    try {
      const res = await fetch(`/admin/suppliers/extract-from-pdf`, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: formData,
      });
      const data = await res.json();

      if (data.error) {
        alert(data.error);
        return;
      }

      extractedSupplierData = data.extracted_fields || {};
      showSupplierExtractedPreview(extractedSupplierData);
    } catch (e) {
      alert('Failed to extract fields from PDF.');
    }
  }

  function showSupplierExtractedPreview(fields) {
    const container = document.getElementById('extracted-fields');
    let html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<tr><th style="text-align:left; padding:8px;">Field</th><th style="text-align:left; padding:8px;">Extracted Value</th></tr>';
    for (const [field, value] of Object.entries(fields)) {
      html += `<tr>
        <td style="padding:8px; font-weight:500;">${field}</td>
        <td style="padding:8px;"><input type="text" id="ext-${field}" value="${value}" style="width:100%;" /></td>
      </tr>`;
    }
    html += '</table>';
    container.innerHTML = html;
    document.getElementById('extracted-preview').style.display = 'block';
  }

  function applySupplierExtracted() {
    const fieldMap = {
      'name': 'name',
      'address': 'address',
      'product_service_provided': 'product_service_provided',
      'contact_name': 'contact_name',
      'contact_email': 'contact_email',
      'contact_phone': 'contact_phone',
      'category': 'category',
    };

    for (const [extField, formField] of Object.entries(fieldMap)) {
      const extInput = document.getElementById(`ext-${extField}`);
      const formInput = document.querySelector(`[name="${formField}"]`);
      if (extInput && formInput) {
      formInput.value = extInput.value;
      }
    }

    document.getElementById('extracted-preview').style.display = 'none';
    alert('Fields applied! Review and save when ready.');
  }

  function cancelSupplierExtract() {
    document.getElementById('extracted-preview').style.display = 'none';
    extractedSupplierData = {};
  }

  (function applyStoredSupplierExtract() {
    const params = new URLSearchParams(window.location.search);
    if (!params.has('apply_extract')) return;
    try {
      const stored = sessionStorage.getItem(`supplier_extract_${{ supplier.id }}`);
      if (!stored) return;
      extractedSupplierData = JSON.parse(stored);
      if (extractedSupplierData && Object.keys(extractedSupplierData).length) {
        showSupplierExtractedPreview(extractedSupplierData);
      }
      sessionStorage.removeItem(`supplier_extract_${{ supplier.id }}`);
    } catch (e) {
      // ignore
    }
  })();
  </script>
{% endblock %}
