{% extends "_layout.html" %}
{% block title %}ShipStation Sync{% endblock %}
{% block content %}
  <div class="card">
    <div class="topbar__inner" style="padding: 0; border: 0;">
      <div>
        <h1 style="margin: 0;">ShipStation</h1>
      </div>
      <div style="display:flex; gap:10px; flex-wrap: wrap;">
        <a class="button button--secondary" href="{{ url_for('admin.index') }}">← Back</a>
        <a class="button button--secondary" href="{{ url_for('shipstation_sync.shipstation_diag') }}">Diagnostics</a>
        <form method="post" action="{{ url_for('shipstation_sync.shipstation_run') }}" style="margin:0;">
          <button class="button" type="submit">Run Sync</button>
        </form>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <!-- Sync Configuration -->
  <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px;">
    <div class="card" style="text-align:center;">
      <div class="muted" style="font-size:12px; text-transform:uppercase;">Since Date</div>
      <div style="font-size:24px; font-weight:700; color:var(--primary);">{{ sync_config.since_date }}</div>
      <div class="muted" style="font-size:11px;">SHIPSTATION_SINCE_DATE</div>
    </div>
    <div class="card" style="text-align:center;">
      <div class="muted" style="font-size:12px; text-transform:uppercase;">ShipStation Entries</div>
      <div style="font-size:24px; font-weight:700; color:var(--success);">{{ diag.ss_count }}</div>
      <div class="muted" style="font-size:11px;">distribution_log_entries</div>
    </div>
    <div class="card" style="text-align:center;">
      <div class="muted" style="font-size:12px; text-transform:uppercase;">Last Order Date</div>
      <div style="font-size:24px; font-weight:700;">{% if diag.ss_max_ship_date %}{{ diag.ss_max_ship_date }}{% else %}—{% endif %}</div>
      <div class="muted" style="font-size:11px;">source=shipstation</div>
    </div>
    <div class="card" style="text-align:center;">
      <div class="muted" style="font-size:12px; text-transform:uppercase;">API Status</div>
      <div style="font-size:24px; font-weight:700; color:{% if sync_config.api_key_set and sync_config.api_secret_set %}var(--success){% else %}var(--danger){% endif %};">
        {% if sync_config.api_key_set and sync_config.api_secret_set %}Ready{% else %}Missing{% endif %}
      </div>
      <div class="muted" style="font-size:11px;">credentials</div>
    </div>
  </div>

  {% if limit_warning %}
  <div style="height: 14px;"></div>
  <div class="card" style="border-left:4px solid #f59e0b; background:linear-gradient(180deg, rgba(245,158,11,0.1), rgba(245,158,11,0.05));">
    <h3 style="margin-top:0; color:#f59e0b;">⚠️ Sync Limit Reached</h3>
    <p style="margin:0;">The last sync stopped early due to order/page limits. To sync more orders, increase the environment variables:</p>
    <ul style="margin:8px 0;">
      <li><code>SHIPSTATION_MAX_ORDERS</code> (current: {{ sync_config.max_orders }})</li>
      <li><code>SHIPSTATION_MAX_PAGES</code> (current: {{ sync_config.max_pages }})</li>
    </ul>
    <p class="muted" style="margin:0; font-size:12px;">After increasing limits, run sync again to fetch additional orders.</p>
  </div>
  {% endif %}

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">DB Summary</h2>
    <ul>
      <li><strong>Total distribution entries:</strong> {{ diag.total }}</li>
      <li><strong>By source:</strong>
        {% if diag.by_source %}
          {% for src, cnt in diag.by_source.items() %}
            <code>{{ src }}</code>={{ cnt }}{% if not loop.last %}, {% endif %}
          {% endfor %}
        {% else %}
          <span class="muted">none</span>
        {% endif %}
      </li>
      <li><strong>All sources date range:</strong>
        {% if diag.min_ship_date %}{{ diag.min_ship_date }} – {{ diag.max_ship_date }}{% else %}<span class="muted">no data</span>{% endif %}
      </li>
      <li><strong>ShipStation date range:</strong>
        {% if diag.ss_min_ship_date %}{{ diag.ss_min_ship_date }} – {{ diag.ss_max_ship_date }}{% else %}<span class="muted">no data</span>{% endif %}
      </li>
      <li><strong>Sync runs:</strong> {{ sync_run_count }}</li>
      <li><strong>Skipped orders logged:</strong> {{ skipped_count }}</li>
    </ul>
  </div>

  <div style="height: 14px;"></div>

  {% if top_skip_reasons %}
  <div class="card">
    <h2 style="margin-top:0;">Top Skip Reasons</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left; padding: 8px;">Reason</th>
          <th style="text-align:right; padding: 8px;">Count</th>
        </tr>
      </thead>
      <tbody>
        {% for reason, cnt in top_skip_reasons %}
          <tr style="border-top: 1px solid var(--border);">
            <td style="padding: 8px;"><code>{{ reason|e }}</code></td>
            <td style="padding: 8px; text-align:right;">{{ cnt }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div style="height: 14px;"></div>
  {% endif %}

  <div class="card">
    <h2 style="margin-top:0;">Recent runs</h2>
    {% if runs %}
      <div style="overflow-x:auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding: 8px;">Ran at</th>
              <th style="text-align:right; padding: 8px;">Synced</th>
              <th style="text-align:right; padding: 8px;">Skipped</th>
              <th style="text-align:right; padding: 8px;">Orders</th>
              <th style="text-align:right; padding: 8px;">Shipments</th>
              <th style="text-align:right; padding: 8px;">Duration (s)</th>
              <th style="text-align:left; padding: 8px;">Message</th>
            </tr>
          </thead>
          <tbody>
            {% for r in runs %}
              <tr style="border-top: 1px solid var(--border);">
                <td style="padding: 8px;">{{ r.ran_at }}</td>
                <td style="padding: 8px; text-align:right;">{{ r.synced_count }}</td>
                <td style="padding: 8px; text-align:right;">{{ r.skipped_count }}</td>
                <td style="padding: 8px; text-align:right;">{{ r.orders_seen }}</td>
                <td style="padding: 8px; text-align:right;">{{ r.shipments_seen }}</td>
                <td style="padding: 8px; text-align:right;">{{ r.duration_seconds }}</td>
                <td style="padding: 8px;">{% if r.message %}{{ r.message|e }}{% else %}<span class="muted">—</span>{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted">No sync runs yet.</p>
    {% endif %}
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">Recent skipped</h2>
    {% if skipped %}
      <div style="overflow-x:auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding: 8px;">Time</th>
              <th style="text-align:left; padding: 8px;">Order</th>
              <th style="text-align:left; padding: 8px;">Reason</th>
            </tr>
          </thead>
          <tbody>
            {% for x in skipped %}
              <tr style="border-top: 1px solid var(--border);">
                <td style="padding: 8px;">{{ x.created_at }}</td>
                <td style="padding: 8px;">{% if x.order_number %}<code>{{ x.order_number|e }}</code>{% else %}<span class="muted">—</span>{% endif %}</td>
                <td style="padding: 8px;"><code>{{ x.reason|e }}</code></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <p class="muted" style="margin-top:10px;">Details JSON is stored in DB for diagnostics.</p>
    {% else %}
      <p class="muted">No skipped orders logged.</p>
    {% endif %}
  </div>
{% endblock %}

