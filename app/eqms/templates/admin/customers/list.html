{% extends "_layout.html" %}
{% block title %}Customers{% endblock %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h1 style="margin-top:0;">Customers</h1>
        <p class="muted" style="margin:0; font-size:13px;">Customers with matched catheter distributions. NRE/engineering customers appear in NRE Projects.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <a class="button" href="{{ url_for('customer_profiles.customers_new_get') }}">+ New Customer</a>
        <a class="button button--secondary" href="{{ url_for('customer_profiles.reps_list') }}">Reps</a>
      </div>
    </div>

    <form class="form" method="get" action="{{ url_for('customer_profiles.customers_list') }}" style="max-width:none; margin-top:16px;">
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
        <div>
          <div class="label">Search</div>
          <input name="q" value="{{ q|e }}" placeholder="Name, city, or key..." />
        </div>
        <div>
          <div class="label">State</div>
          <select name="state" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All States</option>
            {% for s in state_options|default([]) %}
              <option value="{{ s }}" {% if state == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <div class="label">Year</div>
          <select name="year" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Years</option>
            <option value="2026" {% if year == "2026" %}selected{% endif %}>2026</option>
            <option value="2025" {% if year == "2025" %}selected{% endif %}>2025</option>
          </select>
        </div>
        <div>
          <div class="label">Primary Rep</div>
          <select name="rep_id" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Reps</option>
            {% for r in reps or [] %}
              <option value="{{ r.id }}" {% if rep_id == r.id|string %}selected{% endif %}>{{ r.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="button" type="submit">Apply Filters</button>
        <a class="button button--secondary" href="{{ url_for('customer_profiles.customers_list') }}">Clear</a>
      </div>
    </form>
  </div>

  <div style="height: 14px;"></div>
  <div class="card">
    {% if customers %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;" id="customersTable">
          <thead>
            <tr>
              <th class="sortable" data-sort="facility" style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted); cursor:pointer;">
                Facility <span class="sort-icon">↕</span>
              </th>
              <th class="sortable" data-sort="location" style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted); cursor:pointer;">
                Location <span class="sort-icon">↕</span>
              </th>
              <th class="sortable" data-sort="orders" style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted); cursor:pointer;">
                Orders <span class="sort-icon">↕</span>
              </th>
              <th class="sortable" data-sort="units" style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted); cursor:pointer;">
                Units <span class="sort-icon">↕</span>
              </th>
              <th class="sortable" data-sort="lastorder" style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted); cursor:pointer;">
                Last Order <span class="sort-icon">↕</span>
              </th>
            </tr>
          </thead>
          <tbody>
            {% for c in customers %}
              {% set stats = customer_stats.get(c.id, {}) %}
              <tr style="border-bottom:1px solid rgba(255,255,255,0.05);"
                  data-facility="{{ c.facility_name|lower }}"
                  data-location="{{ ((c.city or '') + ', ' + (c.state or ''))|lower }}"
                  data-orders="{{ stats.order_count|default(0) }}"
                  data-units="{{ stats.total_units|default(0) }}"
                  data-lastorder="{{ stats.last_order or '0000-00-00' }}">
                <td style="padding:10px 12px;">
                  <a href="{{ url_for('customer_profiles.customer_detail', customer_id=c.id) }}" style="font-weight:500;">{{ c.facility_name|e }}</a>
                  {% if c.customer_code %}
                    <code style="font-size:10px; padding:1px 4px; border-radius:3px; background:rgba(102,163,255,0.1); color:var(--primary); margin-left:4px;">{{ c.customer_code|e }}</code>
                  {% endif %}
                  {% if note_counts and note_counts.get(c.id, 0) > 0 %}
                    <button type="button" onclick="openNotesModal('customer', {{ c.id }})" style="font-size:10px; padding:2px 6px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary); margin-left:6px; border:none; cursor:pointer;">
                      {{ note_counts.get(c.id, 0) }} note{{ 's' if note_counts.get(c.id, 0) != 1 else '' }}
                    </button>
                  {% endif %}
                </td>
                <td style="padding:10px 12px;">
                  <span>{{ (c.city or "")|e }}</span>{% if c.city and c.state %}, {% endif %}<span>{{ (c.state or "")|e }}</span>
                </td>
                <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ stats.order_count|default(0) }}</td>
                <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ stats.total_units|default(0) }}</td>
                <td style="padding:10px 12px; font-size:12px; color:var(--muted);">{% if stats.last_order %}{{ stats.last_order }}{% else %}—{% endif %}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div style="text-align:center; padding:40px 20px;">
        <p class="muted" style="margin:0 0 12px 0;">No customers found.</p>
        <p class="muted" style="font-size:12px; margin:0 0 16px 0;">Try adjusting your filters or create a new customer.</p>
        <a class="button button--secondary" href="{{ url_for('customer_profiles.customers_new_get') }}">+ Create Customer</a>
      </div>
    {% endif %}
  </div>

  <div style="height: 14px;"></div>
  <div class="card" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
    <div class="muted" style="font-size:12px;">
      Showing {{ ((page - 1) * 50) + 1 }}–{{ [page * 50, total]|min }} of {{ total }} customers
    </div>
    <div style="display:flex; gap:10px;">
      {% if has_prev %}
        <a class="button button--secondary" style="font-size:12px; padding:6px 12px;" href="{{ url_for('customer_profiles.customers_list', q=q, state=state, rep_id=rep_id, year=year, page=page-1) }}">← Previous</a>
      {% endif %}
      {% if has_next %}
        <a class="button button--secondary" style="font-size:12px; padding:6px 12px;" href="{{ url_for('customer_profiles.customers_list', q=q, state=state, rep_id=rep_id, year=year, page=page+1) }}">Next →</a>
      {% endif %}
    </div>
  </div>

<script>
(function() {
  const table = document.getElementById('customersTable');
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { col: null, asc: true };

  headers.forEach(th => {
    th.addEventListener('click', function() {
      const col = this.dataset.sort;
      currentSort.asc = (currentSort.col === col) ? !currentSort.asc : true;
      currentSort.col = col;
      
      // Update icons
      headers.forEach(h => h.querySelector('.sort-icon').textContent = '↕');
      this.querySelector('.sort-icon').textContent = currentSort.asc ? '↑' : '↓';
      
      // Sort rows
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.sort((a, b) => {
        let aVal = a.dataset[col];
        let bVal = b.dataset[col];
        
        // Numeric columns
        if (col === 'orders' || col === 'units') {
          aVal = parseInt(aVal) || 0;
          bVal = parseInt(bVal) || 0;
          return currentSort.asc ? aVal - bVal : bVal - aVal;
        }
        
        // Date column
        if (col === 'lastorder') {
          return currentSort.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        }
        
        // Text columns
        return currentSort.asc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
      });
      
      rows.forEach(row => tbody.appendChild(row));
    });
  });
})();
</script>
{% endblock %}

