{% extends "_layout.html" %}
{% block title %}Sales Orders{% endblock %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h1 style="margin-top:0;">Sales Orders</h1>
        <p class="muted" style="margin:0;">Source of truth for customer orders and distributions.</p>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="button button--secondary" href="{{ url_for('admin.index') }}">‚Üê Back</a>
        <a class="button" href="{{ url_for('rep_traceability.sales_orders_import_pdf_get') }}">Import PDF</a>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <form class="form" method="get" action="{{ url_for('rep_traceability.sales_orders_list') }}" style="max-width:none;">
      <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px;">
        <div>
          <div class="label">Source</div>
          <select name="source" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Sources</option>
            <option value="shipstation" {% if filters.source == 'shipstation' %}selected{% endif %}>ShipStation</option>
            <option value="manual" {% if filters.source == 'manual' %}selected{% endif %}>Manual</option>
            <option value="csv_import" {% if filters.source == 'csv_import' %}selected{% endif %}>CSV Import</option>
            <option value="pdf_import" {% if filters.source == 'pdf_import' %}selected{% endif %}>PDF Import</option>
          </select>
        </div>
        <div>
          <div class="label">Customer</div>
          <select name="customer_id" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:rgba(0,0,0,0.25); color:var(--text);">
            <option value="">All Customers</option>
            {% for c in customers %}
            <option value="{{ c.id }}" {% if filters.customer_id == c.id|string %}selected{% endif %}>{{ c.facility_name[:40] }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <div class="label">Start Date</div>
          <input type="date" name="start_date" value="{{ filters.start_date }}" />
        </div>
        <div>
          <div class="label">End Date</div>
          <input type="date" name="end_date" value="{{ filters.end_date }}" />
        </div>
        <div>
          <div class="label">Search</div>
          <input type="text" name="search" value="{{ filters.search }}" placeholder="Order #..." />
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px;">
        <button class="button" type="submit">Apply</button>
        <a class="button button--secondary" href="{{ url_for('rep_traceability.sales_orders_list') }}">Clear</a>
      </div>
    </form>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    {% if orders %}
      <div style="overflow-x:auto;">
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Order #</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Order Date</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Ship Date</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Customer</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Source</th>
              <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Status</th>
              <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Lines</th>
              <th style="text-align:center; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);"></th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
              <td style="padding:10px 12px;"><code style="font-size:12px; font-weight:600;">{{ o.order_number }}</code></td>
              <td style="padding:10px 12px; font-size:13px;">{{ o.order_date }}</td>
              <td style="padding:10px 12px; font-size:13px;">{{ o.ship_date or '‚Äî' }}</td>
              <td style="padding:10px 12px;">
                {% if o.customer %}
                <a href="{{ url_for('customer_profiles.customer_detail', customer_id=o.customer_id) }}" style="font-weight:500;">{{ o.customer.facility_name[:40] }}</a>
                {% else %}
                <span class="muted">‚Äî</span>
                {% endif %}
              </td>
              <td style="padding:10px 12px;">
                {% if o.source == 'shipstation' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">ShipStation</span>
                {% elif o.source == 'manual' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">Manual</span>
                {% elif o.source == 'csv_import' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(61,220,151,0.15); color:var(--success);">CSV</span>
                {% elif o.source == 'pdf_import' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(168,85,247,0.15); color:#a855f7;">PDF</span>
                {% else %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">{{ o.source }}</span>
                {% endif %}
              </td>
              <td style="padding:10px 12px;">
                {% if o.status == 'completed' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(61,220,151,0.15); color:var(--success);">completed</span>
                {% elif o.status == 'shipped' %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">shipped</span>
                {% else %}
                  <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(250,204,21,0.15); color:#facc15;">{{ o.status }}</span>
                {% endif %}
              </td>
              <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ o.lines|length }}</td>
              <td style="padding:10px 12px; text-align:center;">
                <button class="button button--secondary" style="padding:4px 10px; font-size:11px; margin-right:4px;" onclick="showOrderDetails('{{ o.order_number|e }}')">Details</button>
                <a class="button button--secondary" style="padding:4px 10px; font-size:11px;" href="{{ url_for('rep_traceability.sales_order_detail', order_id=o.id) }}">View</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="muted" style="text-align:center; padding:24px;">No sales orders found.</p>
    {% endif %}
  </div>

  {% if total_pages > 1 %}
  <div style="height: 14px;"></div>
  <div class="card" style="display:flex; justify-content:center; align-items:center; gap:16px; padding:12px;">
    {% if has_prev %}
    <a class="button button--secondary" style="padding:6px 14px; font-size:13px;" href="?page={{ page - 1 }}&source={{ filters.source }}&customer_id={{ filters.customer_id }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}&search={{ filters.search }}">‚Üê Previous</a>
    {% endif %}
    <span class="muted" style="font-size:13px;">Page {{ page }} of {{ total_pages }} ({{ total }} orders)</span>
    {% if has_next %}
    <a class="button button--secondary" style="padding:6px 14px; font-size:13px;" href="?page={{ page + 1 }}&source={{ filters.source }}&customer_id={{ filters.customer_id }}&start_date={{ filters.start_date }}&end_date={{ filters.end_date }}&search={{ filters.search }}">Next ‚Üí</a>
    {% endif %}
  </div>
  {% endif %}

  <!-- Order Details Modal -->
  <dialog id="order-details-modal" style="max-width:700px; width:90vw; max-height:80vh; border:1px solid var(--border); border-radius:14px; background:var(--card-bg); color:var(--text); box-shadow:var(--shadow); padding:0;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border);">
      <h2 style="margin:0; font-size:18px;">Order Details</h2>
      <button onclick="document.getElementById('order-details-modal').close()" style="background:none; border:none; color:var(--muted); font-size:20px; cursor:pointer;">&times;</button>
    </div>
    <div id="order-details-content" style="padding:20px; max-height:60vh; overflow-y:auto;">
      <div class="muted" style="text-align:center; padding:20px;">Loading...</div>
    </div>
  </dialog>

  <script>
  async function showOrderDetails(orderNumber) {
    const modal = document.getElementById('order-details-modal');
    const content = document.getElementById('order-details-content');
    content.innerHTML = '<div class="muted" style="text-align:center; padding:20px;">Loading...</div>';
    modal.showModal();
    try {
      const res = await fetch(`/admin/sales-dashboard/order-details/${encodeURIComponent(orderNumber)}`);
      const data = await res.json();
      if (data.error) {
        content.innerHTML = `<div style="color:var(--danger); text-align:center; padding:20px;">${data.error}</div>`;
        return;
      }
      let html = `
        <div style="margin-bottom:16px;">
          <div style="font-size:11px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Order</div>
          <div style="display:grid; grid-template-columns: auto 1fr; gap:4px 12px;">
            <div class="muted">Order #:</div><div><strong>${data.order_number}</strong></div>
            <div class="muted">Order Date:</div><div>${data.order_date || '‚Äî'}</div>
            <div class="muted">Ship Date:</div><div>${data.ship_date || '‚Äî'}</div>
            <div class="muted">Customer:</div><div>${data.customer || '‚Äî'}</div>
            <div class="muted">Status:</div><div>${data.status || '‚Äî'}</div>
          </div>
        </div>
      `;
      if (data.lines && data.lines.length) {
        html += `<div style="margin-bottom:16px;"><div style="font-size:11px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Order Lines</div>`;
        html += `<table style="width:100%; border-collapse:collapse;"><thead><tr>
          <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border); font-size:11px; color:var(--muted);">SKU</th>
          <th style="text-align:right; padding:6px 8px; border-bottom:1px solid var(--border); font-size:11px; color:var(--muted);">Qty</th>
          <th style="text-align:left; padding:6px 8px; border-bottom:1px solid var(--border); font-size:11px; color:var(--muted);">Lot</th>
        </tr></thead><tbody>`;
        for (const l of data.lines) {
          html += `<tr><td style="padding:6px 8px;"><code>${l.sku}</code></td><td style="padding:6px 8px; text-align:right;">${l.quantity}</td><td style="padding:6px 8px;">${l.lot_number || '‚Äî'}</td></tr>`;
        }
        html += `</tbody></table></div>`;
      }
      // PDF Attachments section
      if (data.attachments && data.attachments.length > 0) {
        html += `<div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">`;
        html += `<div style="font-size:11px; text-transform:uppercase; color:var(--muted); margin-bottom:8px;">Attachments</div>`;
        for (const a of data.attachments) {
          html += `<div style="margin-bottom:6px;"><a href="/admin/sales-orders/pdf/${a.id}/download" class="button button--secondary" style="font-size:12px; padding:6px 12px;">üìÑ ${a.filename}</a></div>`;
        }
        html += `</div>`;
      }
      content.innerHTML = html;
    } catch (e) {
      content.innerHTML = '<div style="color:var(--danger); text-align:center; padding:20px;">Error loading details</div>';
    }
  }

  document.getElementById('order-details-modal').addEventListener('click', function(e) {
    if (e.target === this) this.close();
  });
  </script>
{% endblock %}
