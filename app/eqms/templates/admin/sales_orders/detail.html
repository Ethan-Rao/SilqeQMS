{% extends "_layout.html" %}
{% block title %}Sales Order: {{ order.order_number }}{% endblock %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
      <div>
        <h1 style="margin-top:0;">Sales Order: {{ order.order_number }}</h1>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <a class="button button--secondary" href="{{ url_for('rep_traceability.sales_orders_list') }}">← Back to List</a>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">Order Details</h2>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Order Number</div>
        <div style="font-weight:600;">{{ order.order_number }}</div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Order Date</div>
        <div>{{ order.order_date }}</div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Ship Date</div>
        <div>{{ order.ship_date or '—' }}</div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Status</div>
        <div>
          {% if order.status == 'completed' %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(61,220,151,0.15); color:var(--success);">completed</span>
          {% elif order.status == 'shipped' %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">shipped</span>
          {% else %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(250,204,21,0.15); color:#facc15;">{{ order.status }}</span>
          {% endif %}
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Customer</div>
        <div>
          {% if order.customer %}
          <a href="{{ url_for('customer_profiles.customer_detail', customer_id=order.customer_id) }}" style="font-weight:500;">{{ order.customer.facility_name }}</a>
          {% else %}
          <span class="muted">—</span>
          {% endif %}
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Source</div>
        <div>
          {% if order.source == 'shipstation' %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">ShipStation</span>
          {% elif order.source == 'manual' %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">Manual</span>
          {% elif order.source == 'pdf_import' %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(168,85,247,0.15); color:#a855f7;">PDF</span>
          {% else %}
            <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">{{ order.source }}</span>
          {% endif %}
        </div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Tracking</div>
        <div>{{ order.tracking_number or '—' }}</div>
      </div>
      <div>
        <div class="muted" style="font-size:11px; text-transform:uppercase; margin-bottom:4px;">Created</div>
        <div class="muted" style="font-size:13px;">{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">Order Lines ({{ order.lines|length }})</h2>
    {% if order.lines %}
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">#</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">SKU</th>
            <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Quantity</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Lot Number</th>
          </tr>
        </thead>
        <tbody>
          {% for line in order.lines %}
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:10px 12px; font-size:13px;">{{ line.line_number or loop.index }}</td>
            <td style="padding:10px 12px;"><code style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:12px;">{{ line.sku }}</code></td>
            <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ line.quantity }}</td>
            <td style="padding:10px 12px;"><code style="font-size:12px;">{{ line.lot_number or '—' }}</code></td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr style="background:rgba(255,255,255,0.03);">
            <td style="padding:10px 12px;"></td>
            <td style="padding:10px 12px; font-weight:600;">Total</td>
            <td style="padding:10px 12px; text-align:right; font-weight:700;">{{ order.lines|sum(attribute='quantity') }}</td>
            <td style="padding:10px 12px;"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="muted">No order lines.</p>
    {% endif %}
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">PDF Attachments</h2>
    <form class="form" method="post" action="{{ url_for('rep_traceability.sales_order_upload_pdf', order_id=order.id) }}" enctype="multipart/form-data" style="max-width:480px;">
      <div>
        <div class="label">Upload PDF</div>
        <input type="file" name="pdf_file" accept=".pdf,application/pdf" required />
      </div>
      <button class="button button--secondary" type="submit">Upload PDF</button>
    </form>
    <div style="height: 10px;"></div>
    {% if pdf_attachments %}
      <div style="display:flex; flex-direction:column; gap:6px;">
        {% for a in pdf_attachments %}
          <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:rgba(255,255,255,0.02);">
            <div>
              <div style="font-size:13px; font-weight:600;">{{ a.filename }}</div>
              <div class="muted" style="font-size:11px;">{{ a.pdf_type }} • {{ a.uploaded_at.strftime('%Y-%m-%d') }}</div>
            </div>
            <a class="button button--secondary" style="font-size:12px; padding:4px 10px;" href="{{ url_for('rep_traceability.sales_order_pdf_download', attachment_id=a.id) }}">Download</a>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No PDFs attached.</p>
    {% endif %}
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <h2 style="margin-top:0;">Linked Distributions ({{ distributions|length }})</h2>
    {% if distributions %}
    <div style="overflow-x:auto;">
      <table style="width:100%; border-collapse:collapse;">
        <thead>
          <tr>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Ship Date</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">SKU</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Lot</th>
            <th style="text-align:right; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Qty</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Facility</th>
            <th style="text-align:left; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);">Source</th>
            <th style="text-align:center; padding:10px 12px; border-bottom:1px solid var(--border); font-size:11px; text-transform:uppercase; color:var(--muted);"></th>
          </tr>
        </thead>
        <tbody>
          {% for d in distributions %}
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:10px 12px; font-size:13px;">{{ d.ship_date }}</td>
            <td style="padding:10px 12px;"><code style="background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px; font-size:12px;">{{ d.sku }}</code></td>
            <td style="padding:10px 12px;"><code style="font-size:12px;">{{ d.lot_number }}</code></td>
            <td style="padding:10px 12px; text-align:right; font-weight:600;">{{ d.quantity }}</td>
            <td style="padding:10px 12px;">{{ d.facility_name[:30] }}</td>
            <td style="padding:10px 12px;">
              {% if d.source == 'shipstation' %}
                <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(102,163,255,0.15); color:var(--primary);">ShipStation</span>
              {% elif d.source == 'manual' %}
                <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">Manual</span>
              {% elif d.source == 'pdf_import' %}
                <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(168,85,247,0.15); color:#a855f7;">PDF</span>
              {% else %}
                <span style="font-size:11px; padding:2px 8px; border-radius:4px; background:rgba(255,255,255,0.05); color:var(--muted);">{{ d.source }}</span>
              {% endif %}
            </td>
            <td style="padding:10px 12px; text-align:center;">
              <a class="button button--secondary" style="padding:4px 12px; font-size:12px;" href="{{ url_for('rep_traceability.distribution_log_edit_get', entry_id=d.id) }}">Edit</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
        <tfoot>
          <tr style="background:rgba(255,255,255,0.03);">
            <td style="padding:10px 12px;" colspan="3"><strong>Total</strong></td>
            <td style="padding:10px 12px; text-align:right; font-weight:700;">{{ distributions|sum(attribute='quantity') }}</td>
            <td style="padding:10px 12px;" colspan="3"></td>
          </tr>
        </tfoot>
      </table>
    </div>
    {% else %}
    <p class="muted">No linked distribution entries.</p>
    {% endif %}
  </div>

  {% if order.notes %}
  <div style="height: 14px;"></div>
  <div class="card">
    <h2 style="margin-top:0;">Notes</h2>
    <pre style="background:rgba(0,0,0,0.2); padding:12px; border-radius:8px; font-size:13px; overflow-x:auto; white-space:pre-wrap;">{{ order.notes }}</pre>
  </div>
  {% endif %}
{% endblock %}
