{% extends "_layout.html" %}
{% block title %}Edit Equipment: {{ equipment.equip_code }}{% endblock %}
{% block content %}
  <div class="card">
    <h1>Edit Equipment: {{ equipment.equip_code|e }}</h1>

    <form class="form" method="post" action="{{ url_for('equipment.equipment_edit_post', equipment_id=equipment.id) }}">
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div class="label">Equipment Code</div>
          <input value="{{ equipment.equip_code|e }}" disabled readonly />
          <small class="muted">Cannot be changed after creation.</small>
        </div>
        <div>
          <div class="label">Status</div>
          <select name="status">
            <option value="Active" {{ 'selected' if equipment.status == 'Active' }}>Active</option>
            <option value="Inactive" {{ 'selected' if equipment.status == 'Inactive' }}>Inactive</option>
            <option value="Retired" {{ 'selected' if equipment.status == 'Retired' }}>Retired</option>
            <option value="Calibration Overdue" {{ 'selected' if equipment.status == 'Calibration Overdue' }}>Calibration Overdue</option>
            <option value="PM Overdue" {{ 'selected' if equipment.status == 'PM Overdue' }}>PM Overdue</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Description</div>
          <input name="description" value="{{ (equipment.description or '')|e }}" placeholder="Equipment description" />
        </div>
        <div>
          <div class="label">Manufacturer</div>
          <input name="mfg" value="{{ (equipment.mfg or '')|e }}" placeholder="e.g. Acme Corp" />
        </div>
        <div>
          <div class="label">Model No</div>
          <input name="model_no" value="{{ (equipment.model_no or '')|e }}" placeholder="Model number" />
        </div>
        <div>
          <div class="label">Serial No</div>
          <input name="serial_no" value="{{ (equipment.serial_no or '')|e }}" placeholder="Serial number" />
        </div>
        <div>
          <div class="label">Date in Service</div>
          <input type="date" name="date_in_service" value="{{ equipment.date_in_service or '' }}" />
        </div>
        <div>
          <div class="label">Location</div>
          <input name="location" value="{{ (equipment.location or '')|e }}" placeholder="e.g. Lab A" />
        </div>
        <div></div>
        <div>
          <div class="label">Calibration Interval (days)</div>
          <input type="number" name="cal_interval" min="1" value="{{ equipment.cal_interval or '' }}" placeholder="e.g. 365" />
        </div>
        <div>
          <div class="label">Last Calibration Date</div>
          <input type="date" name="last_cal_date" value="{{ equipment.last_cal_date or '' }}" />
        </div>
        <div>
          <div class="label">Calibration Due Date</div>
          <input type="date" name="cal_due_date" value="{{ equipment.cal_due_date or '' }}" />
        </div>
        <div></div>
        <div>
          <div class="label">PM Interval (days)</div>
          <input type="number" name="pm_interval" min="1" value="{{ equipment.pm_interval or '' }}" placeholder="e.g. 90" />
        </div>
        <div>
          <div class="label">Last PM Date</div>
          <input type="date" name="last_pm_date" value="{{ equipment.last_pm_date or '' }}" />
        </div>
        <div>
          <div class="label">PM Due Date</div>
          <input type="date" name="pm_due_date" value="{{ equipment.pm_due_date or '' }}" />
        </div>
        <div></div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Comments</div>
          <textarea name="comments" rows="3" placeholder="Optional comments...">{{ (equipment.comments or '')|e }}</textarea>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Custom Fields (JSON)</div>
          <textarea name="custom_fields" rows="3" placeholder='{"key":"value"}'>{{ equipment.custom_fields|tojson if equipment.custom_fields else "" }}</textarea>
          <small class="muted">Optional key/value pairs. JSON object only.</small>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Reason for Change *</div>
          <input name="reason" required placeholder="Why are you making this change?" />
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="button" type="submit">Save Changes</button>
        <a class="button button--secondary" href="{{ url_for('equipment.equipment_detail', equipment_id=equipment.id) }}">Cancel</a>
      </div>
    </form>
  </div>

  <div style="height: 14px;"></div>
  <div class="card">
    <h2 style="margin-top:0; font-size:16px;">Upload Document with Auto-Extract</h2>
    <p class="muted" style="font-size:12px;">Upload an Equipment Requirements Form and we'll extract field values automatically.</p>

    <form id="smart-upload-form" enctype="multipart/form-data" style="margin-top:12px;">
      <input type="file" id="pdf-upload" name="pdf_file" accept=".pdf" />
      <button type="button" class="button button--secondary" onclick="extractFromPdf()">Extract Fields</button>
    </form>

    <div id="extracted-preview" style="display:none; margin-top:16px; padding:16px; background:rgba(255,255,255,0.03); border-radius:8px;">
      <h3 style="margin-top:0; font-size:14px;">Extracted Fields (Review & Edit)</h3>
      <div id="extracted-fields"></div>
      <div style="margin-top:12px;">
        <button class="button" type="button" onclick="applyExtracted()">Apply to Form</button>
        <button class="button button--secondary" type="button" onclick="cancelExtract()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
  let extractedData = {};

  async function extractFromPdf() {
    const fileInput = document.getElementById('pdf-upload');
    if (!fileInput.files[0]) {
      alert('Please select a PDF file first.');
      return;
    }

    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);

    try {
      const res = await fetch(`/admin/equipment/{{ equipment.id }}/extract-from-pdf`, {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name=\"csrf-token\"]')?.getAttribute('content') || ''
        },
        body: formData,
      });
      const data = await res.json();

      if (data.error) {
        alert(data.error);
        return;
      }

      extractedData = data.extracted_fields || {};
      showExtractedPreview(extractedData);
    } catch (e) {
      alert('Failed to extract fields from PDF.');
    }
  }

  function showExtractedPreview(fields) {
    const container = document.getElementById('extracted-fields');
    let html = '<table style="width:100%; border-collapse:collapse;">';
    html += '<tr><th style="text-align:left; padding:8px;">Field</th><th style="text-align:left; padding:8px;">Extracted Value</th></tr>';
    for (const [field, value] of Object.entries(fields)) {
      html += `<tr>
        <td style="padding:8px; font-weight:500;">${field}</td>
        <td style="padding:8px;"><input type="text" id="ext-${field}" value="${value}" style="width:100%;" /></td>
      </tr>`;
    }
    html += '</table>';
    container.innerHTML = html;
    document.getElementById('extracted-preview').style.display = 'block';
  }

  function applyExtracted() {
    const fieldMap = {
      'equip_code': 'equip_code',
      'description': 'description',
      'mfg': 'mfg',
      'model_no': 'model_no',
      'serial_no': 'serial_no',
      'location': 'location',
      'cal_interval': 'cal_interval',
      'pm_interval': 'pm_interval',
    };

    for (const [extField, formField] of Object.entries(fieldMap)) {
      const extInput = document.getElementById(`ext-${extField}`);
      const formInput = document.querySelector(`[name="${formField}"]`);
      if (extInput && formInput) {
        formInput.value = extInput.value;
      }
    }

    document.getElementById('extracted-preview').style.display = 'none';
    alert('Fields applied! Review and save when ready.');
  }

  function cancelExtract() {
    document.getElementById('extracted-preview').style.display = 'none';
    extractedData = {};
  }

  (function applyStoredExtract() {
    const params = new URLSearchParams(window.location.search);
    if (!params.has('apply_extract')) return;
    try {
      const stored = sessionStorage.getItem(`equipment_extract_${{ equipment.id }}`);
      if (!stored) return;
      extractedData = JSON.parse(stored);
      if (extractedData && Object.keys(extractedData).length) {
        showExtractedPreview(extractedData);
      }
      sessionStorage.removeItem(`equipment_extract_${{ equipment.id }}`);
    } catch (e) {
      // ignore
    }
  })();
  </script>
{% endblock %}
