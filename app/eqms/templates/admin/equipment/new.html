{% extends "_layout.html" %}
{% block title %}New Equipment{% endblock %}
{% block content %}
  <div class="card">
    <h1>New Equipment</h1>

    <div class="card" style="margin-bottom:14px;">
      <h3 style="margin-top:0; font-size:14px;">Quick Fill from PDF</h3>
      <p class="muted" style="font-size:12px;">Upload an Equipment Requirements Form to auto-fill fields.</p>
      <div style="display:flex; gap:10px; align-items:center; margin-top:12px;">
        <input type="file" id="pdf-upload" accept=".pdf" />
        <button type="button" class="button button--secondary" onclick="extractFromPdf()">Extract Fields</button>
      </div>
      <div id="extract-status" style="margin-top:8px; font-size:12px;"></div>
    </div>

    <form class="form" method="post" action="{{ url_for('equipment.equipment_new_post') }}">
      <input type="hidden" name="pdf_ref" id="pdf-ref-input" />
      <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div class="label">Equipment Code *</div>
          <input name="equip_code" required placeholder="e.g. ST-001" />
        </div>
        <div>
          <div class="label">Status</div>
          <select name="status">
            <option value="Active" selected>Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Retired">Retired</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Description</div>
          <input name="description" placeholder="Equipment description" />
        </div>
        <div>
          <div class="label">Manufacturer</div>
          <input name="mfg" placeholder="e.g. Acme Corp" />
        </div>
        <div>
          <div class="label">Model No</div>
          <input name="model_no" placeholder="Model number" />
        </div>
        <div>
          <div class="label">Serial No</div>
          <input name="serial_no" placeholder="Serial number" />
        </div>
        <div>
          <div class="label">Date in Service</div>
          <input type="date" name="date_in_service" />
        </div>
        <div>
          <div class="label">Location</div>
          <input name="location" placeholder="e.g. Lab A" />
        </div>
        <div></div>
        <div>
          <div class="label">Calibration Interval (days)</div>
          <input type="number" name="cal_interval" min="1" placeholder="e.g. 365" />
        </div>
        <div>
          <div class="label">Last Calibration Date</div>
          <input type="date" name="last_cal_date" />
        </div>
        <div>
          <div class="label">Calibration Due Date</div>
          <input type="date" name="cal_due_date" />
        </div>
        <div></div>
        <div>
          <div class="label">PM Interval (days)</div>
          <input type="number" name="pm_interval" min="1" placeholder="e.g. 90" />
        </div>
        <div>
          <div class="label">Last PM Date</div>
          <input type="date" name="last_pm_date" />
        </div>
        <div>
          <div class="label">PM Due Date</div>
          <input type="date" name="pm_due_date" />
        </div>
        <div></div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Comments</div>
          <textarea name="comments" rows="3" placeholder="Optional comments..."></textarea>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="button" type="submit">Create Equipment</button>
        <a class="button button--secondary" href="{{ url_for('equipment.equipment_list') }}">Cancel</a>
      </div>
    </form>
  </div>

  <script>
  async function extractFromPdf() {
    const fileInput = document.getElementById('pdf-upload');
    const status = document.getElementById('extract-status');

    if (!fileInput.files[0]) {
      status.innerHTML = '<span style="color:var(--danger);">Please select a PDF first.</span>';
      return;
    }

    status.innerHTML = '<span style="color:var(--muted);">Extracting...</span>';

    const formData = new FormData();
    formData.append('pdf_file', fileInput.files[0]);
    formData.append('store_pdf', '1');

    try {
      const res = await fetch('/admin/equipment/extract-from-pdf', {
        method: 'POST',
        headers: {
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: formData,
      });
      const data = await res.json();

      if (data.error) {
        status.innerHTML = `<span style="color:var(--danger);">${data.error}</span>`;
        return;
      }

      if (data.pdf_ref) {
        document.getElementById('pdf-ref-input').value = data.pdf_ref;
      }

      const fieldMap = {
        'equip_code': 'equip_code',
        'description': 'description',
        'mfg': 'mfg',
        'model_no': 'model_no',
        'serial_no': 'serial_no',
        'location': 'location',
        'cal_interval': 'cal_interval',
        'pm_interval': 'pm_interval',
      };

      let filled = 0;
      for (const [extractedField, formField] of Object.entries(fieldMap)) {
        if (data.extracted_fields && data.extracted_fields[extractedField]) {
          const input = document.querySelector(`[name="${formField}"]`);
          if (input && !input.value) {
            input.value = data.extracted_fields[extractedField];
            filled++;
          }
        }
      }

      status.innerHTML = `<span style="color:var(--success);">âœ… Filled ${filled} field(s). Review and save.</span>`;
    } catch (e) {
      status.innerHTML = '<span style="color:var(--danger);">Extraction failed.</span>';
    }
  }
  </script>
{% endblock %}
