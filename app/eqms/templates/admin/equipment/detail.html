{% extends "_layout.html" %}
{% block title %}Equipment: {{ equipment.equip_code }}{% endblock %}
{% block content %}
  <div class="card">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
      <div>
        <h1 style="margin-top:0;">Equipment: {{ equipment.equip_code|e }}</h1>
        <div class="muted">{{ equipment.description or "—" }}</div>
      </div>
      <div style="display:flex; gap:10px;">
        <a class="button" href="{{ url_for('equipment.equipment_edit_get', equipment_id=equipment.id) }}">Edit</a>
        <a class="button button--secondary" href="{{ url_for('equipment.equipment_list') }}">Back to List</a>
      </div>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div class="card">
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="button button--secondary" onclick="showTab('overview')">Overview</button>
      <button class="button button--secondary" onclick="showTab('requirements')">Requirements Form</button>
      <button class="button button--secondary" onclick="showTab('spec')">Specification</button>
      <button class="button button--secondary" onclick="showTab('documents')">Documents</button>
      <button class="button button--secondary" onclick="showTab('suppliers')">Suppliers</button>
      <a class="button button--secondary" href="{{ url_for('equipment.equipment_edit_get', equipment_id=equipment.id) }}">Edit</a>
    </div>
  </div>

  <div style="height: 14px;"></div>

  <div id="tab-overview" class="card tab-panel">
    <h3 style="margin-top:0;">Overview</h3>
    <table class="table">
      <tr><th style="width:180px;">Equip Code</th><td>{{ equipment.equip_code|e }}</td></tr>
      <tr><th>Status</th><td>
        <span class="badge {% if equipment.status == 'Active' %}badge--success{% elif equipment.status in ('Retired', 'Inactive') %}badge--muted{% else %}badge--warning{% endif %}">
          {{ equipment.status|e }}
        </span>
      </td></tr>
      <tr><th>Description</th><td>{{ (equipment.description or "—")|e }}</td></tr>
      <tr><th>Manufacturer</th><td>{{ (equipment.mfg or "—")|e }}</td></tr>
      <tr><th>Model No</th><td>{{ (equipment.model_no or "—")|e }}</td></tr>
      <tr><th>Serial No</th><td>{{ (equipment.serial_no or "—")|e }}</td></tr>
      <tr><th>Date in Service</th><td>{{ equipment.date_in_service or "—" }}</td></tr>
      <tr><th>Location</th><td>{{ (equipment.location or "—")|e }}</td></tr>
      <tr><th>CAL Interval</th><td>{{ equipment.cal_interval or "—" }} days</td></tr>
      <tr><th>Last CAL Date</th><td>{{ equipment.last_cal_date or "—" }}</td></tr>
      <tr>
        <th>CAL Due Date</th>
        <td {% if equipment.cal_due_date and equipment.cal_due_date < today %}style="color: var(--color-danger); font-weight:600;"{% endif %}>
          {{ equipment.cal_due_date or "—" }}
          {% if equipment.cal_due_date and equipment.cal_due_date < today %}(OVERDUE){% endif %}
        </td>
      </tr>
      <tr><th>PM Interval</th><td>{{ equipment.pm_interval or "—" }} days</td></tr>
      <tr><th>Last PM Date</th><td>{{ equipment.last_pm_date or "—" }}</td></tr>
      <tr>
        <th>PM Due Date</th>
        <td {% if equipment.pm_due_date and equipment.pm_due_date < today %}style="color: var(--color-danger); font-weight:600;"{% endif %}>
          {{ equipment.pm_due_date or "—" }}
          {% if equipment.pm_due_date and equipment.pm_due_date < today %}(OVERDUE){% endif %}
        </td>
      </tr>
      <tr><th>Comments</th><td>{{ (equipment.comments or "—")|e }}</td></tr>
    </table>
  </div>

  <div id="tab-requirements" class="card tab-panel" style="display:none;">
    <h3 style="margin-top:0;">Requirements Form</h3>
    {% if primary_docs.requirements_form %}
      <p><strong>{{ primary_docs.requirements_form.original_filename|e }}</strong></p>
      <a class="button button--secondary" href="{{ url_for('equipment.equipment_document_download', equipment_id=equipment.id, doc_id=primary_docs.requirements_form.id) }}">Download</a>
      <form method="post" action="{{ url_for('equipment.equipment_document_delete', equipment_id=equipment.id, doc_id=primary_docs.requirements_form.id) }}" style="display:inline;">
        <input type="hidden" name="reason" value="Deleted via UI" />
        <button type="submit" class="button button--secondary" onclick="return confirm('Delete this document?');">Delete</button>
      </form>
    {% else %}
      <p class="muted">No requirements form uploaded.</p>
    {% endif %}

    <h4 style="margin-top:16px;">Upload Requirements Form</h4>
    <form method="post" action="{{ url_for('equipment.equipment_document_upload', equipment_id=equipment.id, category='requirements_form') }}" enctype="multipart/form-data" class="form">
      <div class="grid" style="grid-template-columns: 2fr 2fr; gap: 12px;">
        <div>
          <div class="label">File *</div>
          <input type="file" name="file" required />
        </div>
        <div>
          <div class="label">Description</div>
          <input name="description" placeholder="Optional description..." />
        </div>
      </div>
      <button class="button" type="submit" style="margin-top:10px;">Upload</button>
    </form>
  </div>

  <div id="tab-spec" class="card tab-panel" style="display:none;">
    <h3 style="margin-top:0;">Specification</h3>
    {% if primary_docs.spec_document %}
      <p><strong>{{ primary_docs.spec_document.original_filename|e }}</strong></p>
      <a class="button button--secondary" href="{{ url_for('equipment.equipment_document_download', equipment_id=equipment.id, doc_id=primary_docs.spec_document.id) }}">Download</a>
      <form method="post" action="{{ url_for('equipment.equipment_document_delete', equipment_id=equipment.id, doc_id=primary_docs.spec_document.id) }}" style="display:inline;">
        <input type="hidden" name="reason" value="Deleted via UI" />
        <button type="submit" class="button button--secondary" onclick="return confirm('Delete this document?');">Delete</button>
      </form>
    {% else %}
      <p class="muted">No specification document uploaded.</p>
    {% endif %}

    <h4 style="margin-top:16px;">Upload Specification</h4>
    <form method="post" action="{{ url_for('equipment.equipment_document_upload', equipment_id=equipment.id, category='spec_document') }}" enctype="multipart/form-data" class="form">
      <div class="grid" style="grid-template-columns: 2fr 2fr; gap: 12px;">
        <div>
          <div class="label">File *</div>
          <input type="file" name="file" required />
        </div>
        <div>
          <div class="label">Description</div>
          <input name="description" placeholder="Optional description..." />
        </div>
      </div>
      <button class="button" type="submit" style="margin-top:10px;">Upload</button>
    </form>
  </div>

  <div id="tab-documents" class="card tab-panel" style="display:none;">
    <h3 style="margin-top:0;">Documents</h3>
    {% for key, label in doc_categories.items() %}
      {% if key not in ("requirements_form", "spec_document") %}
        <div style="margin-bottom:16px;">
          <div class="muted" style="font-size:11px; text-transform:uppercase;">{{ label }}</div>
          {% set docs = documents_by_category.get(key, []) %}
          {% if docs %}
            <ul style="margin:8px 0; padding-left:20px;">
              {% for doc in docs %}
                <li>
                  {{ doc.original_filename|e }}
                  <a href="{{ url_for('equipment.equipment_document_download', equipment_id=equipment.id, doc_id=doc.id) }}">Download</a>
                  <form method="post" action="{{ url_for('equipment.equipment_document_delete', equipment_id=equipment.id, doc_id=doc.id) }}" style="display:inline;">
                    <input type="hidden" name="reason" value="Deleted via UI" />
                    <button type="submit" class="button button--secondary button--small" onclick="return confirm('Delete this document?');" style="margin-left:6px;">Delete</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No documents.</p>
          {% endif %}
          <form method="post" action="{{ url_for('equipment.equipment_document_upload', equipment_id=equipment.id, category=key) }}" enctype="multipart/form-data" class="form">
            <div class="grid" style="grid-template-columns: 2fr 2fr; gap: 12px;">
              <div>
                <div class="label">File *</div>
                <input type="file" name="file" required />
              </div>
              <div>
                <div class="label">Description</div>
                <input name="description" placeholder="Optional description..." />
              </div>
            </div>
            <button class="button button--secondary" type="submit" style="margin-top:8px;">Upload to {{ label }}</button>
          </form>
        </div>
      {% endif %}
    {% endfor %}
  </div>

  <div id="tab-suppliers" class="card tab-panel" style="display:none;">
    <h3 style="margin-top:0;">Suppliers</h3>
    {% if equipment.supplier_associations %}
      <table class="table">
        <thead>
          <tr>
            <th>Supplier</th>
            <th>Relationship Type</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for assoc in equipment.supplier_associations %}
            <tr>
              <td><a href="{{ url_for('suppliers.supplier_detail', supplier_id=assoc.supplier.id) }}">{{ assoc.supplier.name|e }}</a></td>
              <td>{{ (assoc.relationship_type or "—")|e }}</td>
              <td>{{ (assoc.notes or "—")|truncate(50)|e }}</td>
              <td>
                <form method="post" action="{{ url_for('equipment.equipment_supplier_remove', equipment_id=equipment.id, supplier_id=assoc.supplier.id) }}" style="display:inline;">
                  <input type="hidden" name="reason" value="Removed via UI" />
                  <button type="submit" class="button button--secondary button--small" onclick="return confirm('Remove this supplier association?');">Remove</button>
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No associated suppliers.</p>
    {% endif %}

    <h4 style="margin-top:16px;">Add Supplier</h4>
    {% if available_suppliers %}
      <form method="post" action="{{ url_for('equipment.equipment_supplier_add', equipment_id=equipment.id) }}" class="form">
        <div class="grid" style="grid-template-columns: 2fr 1fr 2fr; gap: 12px;">
          <div>
            <div class="label">Supplier</div>
            <select name="supplier_id" required>
              <option value="">Select a supplier...</option>
              {% for sup in available_suppliers %}
                <option value="{{ sup.id }}">{{ sup.name|e }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <div class="label">Relationship Type</div>
            <select name="relationship_type">
              <option value="">Select...</option>
              <option value="Manufacturer">Manufacturer</option>
              <option value="Service Provider">Service Provider</option>
              <option value="Parts Supplier">Parts Supplier</option>
              <option value="Calibration Provider">Calibration Provider</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <div class="label">Notes</div>
            <input name="notes" placeholder="Optional notes..." />
          </div>
        </div>
        <button class="button" type="submit" style="margin-top:10px;">Add Supplier</button>
      </form>
    {% else %}
      <p class="muted">All suppliers are already associated or no suppliers exist. <a href="{{ url_for('suppliers.suppliers_new_get') }}">Create a supplier</a>.</p>
    {% endif %}
  </div>

  <script>
  function showTab(key) {
    document.querySelectorAll('.tab-panel').forEach(p => p.style.display = 'none');
    document.getElementById(`tab-${key}`).style.display = 'block';
  }
  </script>
{% endblock %}
