# Test Plan for REP Traceability (Step 1)

**Date:** 2026-01-15  
**Purpose:** Minimal end-to-end manual tests for non-programmers to verify REP traceability functionality

---

## Prerequisites

1. **Database initialized:**
   - Run `python scripts/init_db.py` to create tables and seed permissions
   - Verify admin user exists (email: `admin@silqeqms.com` or from `ADMIN_EMAIL` env var)

2. **Application running:**
   - Start Flask app (e.g., `flask run` or `gunicorn`)
   - Access application at `http://localhost:5000` (or configured host/port)

3. **Admin user logged in:**
   - Login at `/auth/login` with admin credentials
   - Verify you can access `/admin` dashboard

---

## Test 1: Create Manual Distribution Entry

**Purpose:** Verify manual entry form creates a distribution log entry correctly.

**Steps:**
1. Navigate to `/admin/distribution-log`
2. Click [Manual Entry] button
3. Fill form:
   - Ship Date: `2025-01-15`
   - Order Number: (leave blank to test auto-generation)
   - Facility Name: `Hospital A`
   - Rep: Select a user from dropdown (or leave blank if none)
   - Source: `Manual`
   - SKU: `211810SPT`
   - Lot Number: `SLQ-12345`
   - Quantity: `10`
   - Address: `123 Main St`
   - City: `Springfield`
   - State: `IL`
   - Zip: `62701`
   - Tracking Number: `1Z999AA10123456784`
4. Click [Save Distribution]

**Expected Results:**
- Form submits without errors
- Redirect to `/admin/distribution-log` list page
- Success message displayed: "Distribution entry created successfully"
- Entry appears in list table with:
  - Ship Date: `2025-01-15`
  - Order Number: Auto-generated (e.g., `MAN-20250115103000`)
  - Facility: `Hospital A`
  - Rep: Selected user (or blank)
  - SKU: `211810SPT`
  - Lot: `SLQ-12345`
  - Quantity: `10`
  - Source: `Manual`
- Entry is clickable to edit

**Validation:**
- Check database: `SELECT * FROM distribution_log_entries WHERE facility_name = 'Hospital A';`
- Entry exists with correct values
- Check audit log: `SELECT * FROM audit_events WHERE action = 'distribution_log.create' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 2: Import Distribution from CSV

**Purpose:** Verify CSV import creates multiple distribution log entries correctly.

**Prerequisites:**
- Create a CSV file `test_distributions.csv` with the following content:
  ```csv
  Ship Date,Order Number,Facility Name,Rep,SKU,Lot,Quantity,Address,City,State,Zip
  2025-01-14,SO-12344,Hospital B,,211610SPT,SLQ-23456,5,456 Oak Ave,Chicago,IL,60601
  2025-01-13,SO-12343,Hospital C,,211410SPT,SLQ-34567,8,789 Pine Rd,Peoria,IL,61601
  ```

**Steps:**
1. Navigate to `/admin/distribution-log`
2. Click [Import CSV] button
3. Click [Choose File] and select `test_distributions.csv`
4. Click [Import CSV]

**Expected Results:**
- Form submits without errors
- Import results page displayed (or redirect to list with results message)
- Success message: "CSV import completed: 2 entries created, 0 errors"
- Two entries appear in list table:
  - Entry 1: Hospital B, `2025-01-14`, `SO-12344`, `211610SPT`, `SLQ-23456`, Quantity: `5`
  - Entry 2: Hospital C, `2025-01-13`, `SO-12343`, `211410SPT`, `SLQ-34567`, Quantity: `8`
- Both entries have Source: `csv_import`
- Entries are clickable to edit

**Validation:**
- Check database: `SELECT * FROM distribution_log_entries WHERE source = 'csv_import' ORDER BY ship_date DESC;`
- Two entries exist with correct values
- Check audit log: `SELECT * FROM audit_events WHERE action = 'distribution_log.import_csv' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with metadata: `{rows_processed: 2, rows_created: 2, rows_errors: 0}`

---

## Test 3: Generate Tracing Report for a Month

**Purpose:** Verify tracing report generation creates CSV artifact and metadata record.

**Prerequisites:**
- At least 3 distribution log entries exist (from Tests 1 and 2)
- Entries should have ship dates in the same month (e.g., `2025-01`)

**Steps:**
1. Navigate to `/admin/tracing`
2. Click [Generate] button
3. Fill form:
   - Month: `2025-01` (YYYY-MM format)
   - Rep: (leave blank for "All Reps")
   - Source: (leave blank for "All")
   - SKU: (leave blank for "All")
   - Customer: (leave blank for "All")
4. Click [Generate Report]

**Expected Results:**
- Form submits without errors
- Redirect to `/admin/tracing/<id>` (report detail page)
- Success message: "Report generated successfully"
- Report detail page shows:
  - Generated: `2025-01-15 10:30 AM` (or current timestamp)
  - Generated by: `admin@silqeqms.com` (or current user email)
  - Filters: `January 2025, All Reps, All Sources`
  - Status: `Draft`
  - [Download CSV] button visible
- Report appears in list page (`/admin/tracing`):
  - Generated At: Current date/time
  - Filters: `Jan 2025, All Reps`
  - Status: `Draft`
  - Actions: [View], [Download]

**Validation:**
- Check database: `SELECT * FROM tracing_reports WHERE filters_json->>'month' = '2025-01' ORDER BY generated_at DESC LIMIT 1;`
- Report metadata exists with:
  - `filters_json`: `{"month": "2025-01"}`
  - `report_storage_key`: `tracing_reports/2025-01/{hash}_{timestamp}.csv`
  - `status`: `draft`
- Check storage: CSV file exists at `storage/tracing_reports/2025-01/{hash}_{timestamp}.csv`
- Check audit log: `SELECT * FROM audit_events WHERE action = 'tracing_reports.generate' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 4: Download Tracing Report CSV

**Purpose:** Verify tracing report CSV download works and contains correct data.

**Prerequisites:**
- Complete Test 3 to generate a report

**Steps:**
1. Navigate to `/admin/tracing/<id>` (report detail page from Test 3)
2. Click [Download CSV] button

**Expected Results:**
- CSV file downloads (filename: `tracing_report_{id}_2025-01.csv` or similar)
- CSV file opens in spreadsheet application (Excel, Google Sheets, etc.)
- CSV contains header row: `Ship Date,Order #,Facility,City,State,SKU,Lot,Quantity,Rep,Source`
- CSV contains data rows for all distribution log entries from `2025-01`:
  - At least 3 rows (from Tests 1 and 2)
  - Columns match expected format:
    - Ship Date: `2025-01-15`, `2025-01-14`, `2025-01-13` (or dates from Test 2)
    - Order #: Order numbers from entries
    - Facility: `Hospital A`, `Hospital B`, `Hospital C`
    - City: Cities from entries
    - State: States from entries
    - SKU: `211810SPT`, `211610SPT`, `211410SPT`
    - Lot: `SLQ-12345`, `SLQ-23456`, `SLQ-34567`
    - Quantity: `10`, `5`, `8`
    - Rep: Rep names (or blank)
    - Source: `Manual`, `csv_import`
- Rows sorted by Ship Date (ascending)

**Validation:**
- Check audit log: `SELECT * FROM audit_events WHERE action = 'tracing_reports.download' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 5: Upload Approval .eml File

**Purpose:** Verify .eml upload creates approval evidence linked to tracing report.

**Prerequisites:**
- Complete Test 3 to generate a report
- Create a test .eml file `test_approval.eml` (export from email client or create manually):
  ```
  From: approver@example.com
  To: admin@silqeqms.com
  Subject: Approval: Tracing Report 2025-01
  Date: Mon, 15 Jan 2025 10:30:00 -0500
  
  This email approves the tracing report for January 2025.
  ```
  Save as `test_approval.eml` (plain text file with .eml extension)

**Steps:**
1. Navigate to `/admin/tracing/<id>` (report detail page from Test 3)
2. Scroll to "Approval Evidence" section
3. Click [Choose File] and select `test_approval.eml`
4. Optionally add Notes: `Approved by Quality Manager`
5. Click [Upload Approval]

**Expected Results:**
- Form submits without errors
- Redirect to report detail page (refresh)
- Success message: "Approval evidence uploaded successfully"
- Approval appears in "Uploaded Approvals" list:
  - Date: Current date/time
  - Subject: `Approval: Tracing Report 2025-01` (or extracted from .eml)
  - From: `approver@example.com` (or extracted from .eml)
  - To: `admin@silqeqms.com` (or extracted from .eml)
  - [Download] button visible
- Approval is clickable to download

**Validation:**
- Check database: `SELECT * FROM approvals_eml WHERE report_id = {report_id} ORDER BY uploaded_at DESC LIMIT 1;`
- Approval metadata exists with:
  - `report_id`: Matches report ID from Test 3
  - `storage_key`: `approvals/{report_id}/{timestamp}_{sanitized_subject}.eml`
  - `subject`: Extracted from .eml header
  - `from_email`: Extracted from .eml header
  - `to_email`: Extracted from .eml header
  - `uploaded_by_user_id`: Current user ID
- Check storage: .eml file exists at `storage/approvals/{report_id}/{timestamp}_{sanitized_subject}.eml`
- Check audit log: `SELECT * FROM audit_events WHERE action = 'approvals.upload' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 6: Download Approval .eml File

**Purpose:** Verify approval .eml download works and file can be opened in email client.

**Prerequisites:**
- Complete Test 5 to upload an approval .eml file

**Steps:**
1. Navigate to `/admin/tracing/<id>` (report detail page)
2. Scroll to "Uploaded Approvals" list
3. Click [Download] button next to uploaded approval

**Expected Results:**
- .eml file downloads (filename: `approval_{id}_Approval_Tracing_Report_2025-01.eml` or similar)
- .eml file opens in email client (Outlook, Thunderbird, etc.)
- Email headers visible:
  - From: `approver@example.com`
  - To: `admin@silqeqms.com`
  - Subject: `Approval: Tracing Report 2025-01`
  - Date: `Mon, 15 Jan 2025 10:30:00 -0500`
- Email body visible: `This email approves the tracing report for January 2025.`

**Validation:**
- Check audit log: `SELECT * FROM audit_events WHERE action = 'approvals.download' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 7: Edit Distribution Entry (Reason-for-Change)

**Purpose:** Verify edit form updates entry and requires reason-for-change.

**Prerequisites:**
- Complete Test 1 to create a distribution entry

**Steps:**
1. Navigate to `/admin/distribution-log`
2. Find entry created in Test 1 (Hospital A)
3. Click [Edit] button (or click on row)
4. Update form:
   - Quantity: Change from `10` to `15`
   - Lot Number: Change from `SLQ-12345` to `SLQ-12346`
   - Reason (required): `Correction: Updated quantity and lot number`
5. Click [Save Changes]

**Expected Results:**
- Form submits without errors
- If reason field blank: Error message "Reason is required for edits"
- If reason provided: Redirect to list page with success message
- Entry in list shows updated values:
  - Quantity: `15`
  - Lot: `SLQ-12346`
- Original values no longer visible

**Validation:**
- Check database: `SELECT * FROM distribution_log_entries WHERE facility_name = 'Hospital A';`
- Entry updated with new quantity and lot number
- Check audit log: `SELECT * FROM audit_events WHERE action = 'distribution_log.update' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with:
  - `reason`: `Correction: Updated quantity and lot number`
  - `metadata`: `{before: {quantity: 10, lot_number: "SLQ-12345"}, after: {quantity: 15, lot_number: "SLQ-12346"}, fields_changed: ["quantity", "lot_number"]}`

---

## Test 8: Export Distribution Log as CSV

**Purpose:** Verify CSV export generates file with filtered distribution log entries.

**Prerequisites:**
- Complete Tests 1 and 2 to create distribution entries

**Steps:**
1. Navigate to `/admin/distribution-log`
2. Apply filters (optional):
   - Date From: `2025-01-13`
   - Date To: `2025-01-15`
   - Source: `All`
   - Rep: `All`
   - SKU: `All`
3. Click [Export] button

**Expected Results:**
- CSV file downloads (filename: `distribution_log_export_20250115.csv` or similar)
- CSV file opens in spreadsheet application
- CSV contains header row: `Ship Date,Order #,Facility,City,State,SKU,Lot,Quantity,Rep,Source`
- CSV contains data rows for filtered entries:
  - At least 3 rows (from Tests 1 and 2)
  - Rows match filters (ship dates within range if filtered)
  - Columns match expected format (same as Test 4)
- Rows sorted by Ship Date (ascending)

**Validation:**
- Check audit log: `SELECT * FROM audit_events WHERE action = 'distribution_log.export' ORDER BY created_at DESC LIMIT 1;`
- Audit event exists with correct metadata

---

## Test 9: Validation Errors (Invalid SKU, Lot Format)

**Purpose:** Verify form validation rejects invalid inputs.

**Steps:**
1. Navigate to `/admin/distribution-log`
2. Click [Manual Entry]
3. Fill form with invalid data:
   - Ship Date: `2025-01-15`
   - Facility Name: `Test Hospital`
   - SKU: `INVALID-SKU` (not one of valid values)
   - Lot Number: `INVALID-LOT` (doesn't match `SLQ-#####` format)
   - Quantity: `-5` (negative number)
   - Ship Date: `2026-12-31` (future date)
4. Click [Save Distribution]

**Expected Results:**
- Form validation errors displayed:
  - SKU: "SKU must be one of: 211810SPT, 211610SPT, 211410SPT"
  - Lot Number: "Lot number must match format: SLQ-#####"
  - Quantity: "Quantity must be a positive integer"
  - Ship Date: "Ship date cannot be in the future"
- Form does not submit
- No entry created in database

**Validation:**
- Check database: `SELECT * FROM distribution_log_entries WHERE facility_name = 'Test Hospital';`
- No entry exists

---

## Test 10: Duplicate Detection (CSV Import)

**Purpose:** Verify CSV import detects duplicate entries and warns user.

**Prerequisites:**
- Complete Test 1 to create an entry with Order Number `SO-12344` (or use existing entry)

**Steps:**
1. Create CSV file `test_duplicates.csv` with duplicate entry:
   ```csv
   Ship Date,Order Number,Facility Name,SKU,Lot,Quantity
   2025-01-14,SO-12344,Hospital B,211610SPT,SLQ-23456,5
   ```
   (Same `order_number + ship_date + facility_name` as existing entry)
2. Navigate to `/admin/distribution-log`
3. Click [Import CSV]
4. Upload `test_duplicates.csv`
5. Click [Import CSV]

**Expected Results:**
- Import results displayed:
  - Warning: "Duplicate detected: Order Number `SO-12344`, Ship Date `2025-01-14`, Facility `Hospital B`"
  - Option to override (if implemented) or skip
- If override: Entry created (duplicate allowed)
- If skip: Entry not created
- Original entry remains unchanged

**Validation:**
- Check database: If override allowed, duplicate exists; if skip, only original exists
- Check audit log: Import event logged with `rows_duplicates: 1`

---

## Test Summary Checklist

After completing all tests, verify:

- [ ] Test 1: Manual entry creates distribution log entry
- [ ] Test 2: CSV import creates multiple entries
- [ ] Test 3: Tracing report generation creates CSV artifact and metadata
- [ ] Test 4: Tracing report CSV download contains correct data
- [ ] Test 5: Approval .eml upload creates approval evidence linked to report
- [ ] Test 6: Approval .eml download opens in email client
- [ ] Test 7: Edit entry requires reason-for-change and updates correctly
- [ ] Test 8: CSV export generates file with filtered entries
- [ ] Test 9: Validation errors prevent invalid data entry
- [ ] Test 10: Duplicate detection warns on CSV import

---

## Expected Issues & Troubleshooting

**Issue:** Migration fails with "table already exists"
- **Solution:** Run `alembic downgrade -1` then `alembic upgrade head`

**Issue:** Permissions error (403) on routes
- **Solution:** Verify admin user has all REP permissions: `distribution_log.*`, `tracing_reports.*`, `approvals.*`

**Issue:** CSV import fails with "invalid SKU"
- **Solution:** Verify CSV columns match expected format (case-sensitive)

**Issue:** .eml file doesn't open in email client
- **Solution:** Verify .eml file is valid RFC822 format (headers + body)

**Issue:** Storage files not found
- **Solution:** Verify `STORAGE_BACKEND` env var is set (default: `local`), check `storage/` directory exists

---

## References

- **Checklist:** [docs/step1_rep_migration/00_STEP1_CHECKLIST.md](docs/step1_rep_migration/00_STEP1_CHECKLIST.md)
- **DB Plan:** [docs/step1_rep_migration/01_DB_AND_MIGRATIONS_PLAN.md](docs/step1_rep_migration/01_DB_AND_MIGRATIONS_PLAN.md)
- **Route Map:** [docs/step1_rep_migration/02_ROUTE_MAP.md](docs/step1_rep_migration/02_ROUTE_MAP.md)
- **Data Flow:** [docs/step1_rep_migration/03_DATA_FLOW.md](docs/step1_rep_migration/03_DATA_FLOW.md)
- **Master Spec:** [docs/REP_SYSTEM_MIGRATION_MASTER.md](docs/REP_SYSTEM_MIGRATION_MASTER.md)
