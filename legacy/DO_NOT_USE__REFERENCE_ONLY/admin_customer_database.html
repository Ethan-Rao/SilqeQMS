{% extends "base.html" %}

{% block title %}Customer Database – eQMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Customer Database</h1>
    <div class="d-flex align-items-center gap-3">
      <p class="text-muted mb-0">
        <strong>{{ customers|length }}</strong> unique customers (lifetime)
      </p>
      {% if stats_lifetime %}
      <span class="text-muted">|</span>
      <p class="text-muted mb-0">
        First-Time: <strong>{{ stats_lifetime.first_time_customers_lifetime }}</strong> · 
        Repeat: <strong>{{ stats_lifetime.repeat_customers_lifetime }}</strong>
      </p>
      {% endif %}
    </div>
  </div>
  <div>
    <a href="{{ url_for('admin_sales_dashboard') }}" class="btn btn-outline-primary">
      <i class="bi bi-graph-up me-1"></i> Sales Dashboard
    </a>
  </div>
</div>

<!-- Search/Filter Bar -->
<div class="card shadow-sm mb-3">
  <div class="card-body py-2">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label small mb-1">Search</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
          <input type="text" id="searchCustomer" class="form-control" placeholder="Facility name, city, state...">
        </div>
      </div>
      <div class="col-md-3">
        <label class="form-label small mb-1">State</label>
        <select id="filterState" class="form-select form-select-sm">
          <option value="">All States</option>
          {% for state in states %}
          <option value="{{ state }}">{{ state }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label small mb-1">Type</label>
        <select id="filterOrderStatus" class="form-select form-select-sm">
          <option value="">All Customers</option>
          <option value="new">First-Time Only</option>
          <option value="repeat">Repeat Customers</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- Customer List -->
<div class="card shadow-sm">
  <div class="accordion accordion-flush" id="customerAccordion">
      {% for customer in customers %}
      <div class="accordion-item customer-card border-bottom" 
           data-facility="{{ customer.facility|lower }}"
           data-city="{{ customer.city|lower }}"
           data-state="{{ customer.state|upper }}"
           data-status="{{ 'new' if customer.order_count == 1 else 'repeat' }}">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed fw-semibold" type="button" data-bs-toggle="collapse" data-bs-target="#customer-{{ loop.index }}">
            <div class="w-100 d-flex justify-content-between align-items-center me-3">
              <div>
                <strong class="fs-6">{{ customer.facility }}</strong>
                <div class="text-muted small mt-1">
                  <i class="bi bi-geo-alt me-1"></i>{{ customer.city }}, {{ customer.state }}
                  {% if customer.order_count == 1 %}
                  <span class="badge bg-success ms-2">New Customer</span>
                  {% else %}
                  <span class="badge bg-primary ms-2">{{ customer.order_count }} Orders</span>
                  {% endif %}
                </div>
              </div>
              <div class="text-end text-muted small">
                <div><i class="bi bi-calendar3 me-1"></i>First: {{ customer.first_order_date[:10] }}</div>
                {% if customer.last_order_date != customer.first_order_date %}
                <div><i class="bi bi-calendar-check me-1"></i>Last: {{ customer.last_order_date[:10] }}</div>
                {% endif %}
              </div>
            </div>
          </button>
        </h2>
    <div id="customer-{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#customerAccordion">
      <div class="accordion-body">
        <div class="row">
          <!-- Contact Information -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">Contact Information</h6>
            {% if customer.contact_name %}
            <div class="mb-2">
              <strong><i class="bi bi-person"></i> Contact:</strong><br>
              {{ customer.contact_name }}
            </div>
            {% endif %}
            {% if customer.contact_phone %}
            <div class="mb-2">
              <strong><i class="bi bi-telephone"></i> Phone:</strong><br>
              {{ customer.contact_phone }}
            </div>
            {% endif %}
            {% if customer.contact_email %}
            <div class="mb-2">
              <strong><i class="bi bi-envelope"></i> Email:</strong><br>
              <a href="mailto:{{ customer.contact_email }}">{{ customer.contact_email }}</a>
            </div>
            {% endif %}
            <div class="mb-2">
              <strong><i class="bi bi-mailbox"></i> Shipping Address:</strong><br>
              {{ customer.address_line1 }}<br>
              {% if customer.address_line2 %}{{ customer.address_line2 }}<br>{% endif %}
              {{ customer.city }}, {{ customer.state }} {{ customer.zip_code }}
            </div>
          </div>

          <!-- Order Summary -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">Order Summary</h6>
            <div class="mb-2">
              <strong>Total Orders:</strong> {{ customer.order_count }}
            </div>
            <div class="mb-2">
              <strong>Total Units:</strong> {{ customer.total_units }}
            </div>
            <div class="mb-3">
              <strong>SKU Breakdown:</strong>
              <table class="table table-sm mt-2">
                <tbody>
                  {% for sku, qty in customer.sku_breakdown.items() %}
                  <tr>
                    <td><code>{{ sku }}</code></td>
                    <td class="text-end">{{ qty }} units</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- Recent Orders -->
          <div class="col-md-4">
            <h6 class="border-bottom pb-2 mb-3">Order History</h6>
            <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
              {% for order in customer.orders %}
              <div class="list-group-item px-0 py-2">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <div class="fw-bold">{{ order.order_number }}</div>
                    <small class="text-muted">{{ order.ship_date[:10] }}</small>
                  </div>
                  <span class="badge bg-secondary">{{ order.total_qty }} units</span>
                </div>
                <small class="text-muted">
                  {% for item in order['items'] %}
                  <div>{{ item['sku'] }} × {{ item['qty'] }}</div>
                  {% endfor %}
                </small>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

{% if not customers %}
<div class="card shadow-sm">
  <div class="card-body text-center py-5">
    <i class="bi bi-people text-muted d-block mb-2" style="font-size: 2rem;"></i>
    <p class="text-muted mb-0">No customer records found</p>
    <p class="text-muted small mb-0">Try syncing ShipStation or uploading CSV data</p>
  </div>
</div>
{% endif %}

<style>
.accordion-button:not(.collapsed) {
  background-color: #f8f9fa;
  color: #1f2937;
}

.accordion-button {
  font-weight: 500;
}

.customer-card:hover {
  background-color: #f9fafb;
}
</style>

<script>
// Real-time search and filter
document.getElementById('searchCustomer').addEventListener('input', filterCustomers);
document.getElementById('filterState').addEventListener('change', filterCustomers);
document.getElementById('filterOrderStatus').addEventListener('change', filterCustomers);

function filterCustomers() {
  const searchText = document.getElementById('searchCustomer').value.toLowerCase();
  const stateFilter = document.getElementById('filterState').value;
  const statusFilter = document.getElementById('filterOrderStatus').value;
  
  document.querySelectorAll('.customer-card').forEach(card => {
    const facility = card.dataset.facility || '';
    const city = card.dataset.city || '';
    const state = card.dataset.state || '';
    const status = card.dataset.status || '';
    
    const matchesSearch = !searchText || 
      facility.includes(searchText) || 
      city.includes(searchText) || 
      state.toLowerCase().includes(searchText);
    
    const matchesState = !stateFilter || state === stateFilter;
    const matchesStatus = !statusFilter || status === statusFilter;
    
    if (matchesSearch && matchesState && matchesStatus) {
      card.style.display = '';
    } else {
      card.style.display = 'none';
    }
  });
}
</script>

{% endblock %}
