{% extends "base.html" %}

{% block title %}{{ customer.fields.get('Facility Name', 'Customer Profile') }} – eQMS{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h3 mb-1">
          <i class="bi bi-building text-primary me-2"></i>
          {{ customer.fields.get('Facility Name', 'Unknown Facility') }}
        </h1>
        <div class="d-flex align-items-center gap-3 text-muted small">
          <span><i class="bi bi-hash me-1"></i>Customer ID: <strong>{{ customer.id }}</strong></span>
          <span>•</span>
          <span><i class="bi bi-calendar me-1"></i>Added: {{ customer.uploaded_at[:10] }}</span>
          {% if orders %}
            <span>•</span>
            <span><i class="bi bi-box me-1"></i><strong>{{ orders|length }}</strong> Orders</span>
          {% endif %}
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('admin_new_customer_records') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-arrow-left me-1"></i>Back to List
        </a>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
            <i class="bi bi-gear me-1"></i>Actions
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" onclick="exportCustomerData()">
              <i class="bi bi-download me-2"></i>Export Data
            </a></li>
            <li><a class="dropdown-item" href="#" onclick="viewOrderHistory()">
              <i class="bi bi-clock-history me-2"></i>Full Order History
            </a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item text-warning" href="#" onclick="editCustomer()">
              <i class="bi bi-pencil me-2"></i>Edit Profile
            </a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Alert for recent activity -->
  {% if orders and orders[0].ship_date %}
    <div class="alert alert-info border-0 mb-3 py-2 d-flex align-items-center" id="recentActivityAlert" style="display: none;">
      <i class="bi bi-info-circle me-2"></i>
      <small id="lastOrderMessage">Last order was on {{ orders[0].ship_date|format_date }}</small>
    </div>
  {% endif %}

  <div class="row g-4">
    <!-- Order Summary Stats -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light">
          <h6 class="mb-0 fw-semibold">
            <i class="bi bi-graph-up text-primary me-2"></i>Order Summary
          </h6>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-6">
              <div class="text-center">
                <div class="h3 text-primary mb-0">{{ orders|length }}</div>
                <small class="text-muted">Total Orders</small>
              </div>
            </div>
            <div class="col-6">
              <div class="text-center">
                <div class="h3 text-success mb-0">
                  {% set total_units = orders|sum(attribute='total_items')|default(0) %}
                  {{ total_units }}
                </div>
                <small class="text-muted">Total Units</small>
              </div>
            </div>
            <div class="col-12">
              <div class="text-center">
                <div class="h3 text-info mb-0">
                  {% set unique_skus = orders|map(attribute='sku_summary')|list|unique|length %}
                  {{ by_sku|length if by_sku else unique_skus }}
                </div>
                <small class="text-muted">Device Types</small>
              </div>
            </div>
            {% if orders %}
            <div class="col-12">
              <hr class="my-2">
              <div class="small">
                <div class="d-flex justify-content-between">
                  <span class="text-muted">First Order:</span>
                  <span class="fw-bold">{{ orders[-1].ship_date[:10] if orders[-1].ship_date else 'Unknown' }}</span>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Latest Order:</span>
                  <span class="fw-bold">{{ orders[0].ship_date[:10] if orders[0].ship_date else 'Unknown' }}</span>
                </div>
                {% if by_month %}
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Active Months:</span>
                  <span class="fw-bold">{{ by_month|length }}</span>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          </div>
          
          <!-- Device Breakdown -->
          {% if by_sku %}
          <div class="mt-3">
            <div class="small fw-bold text-muted mb-2">
              <i class="fas fa-cogs me-1"></i>Top Devices
            </div>
            {% for sku, count in by_sku.items()[:3] %}
            <div class="d-flex justify-content-between align-items-center mb-1">
              <span class="small">{{ sku|replace('211810SPT', '18mm')|replace('211610SPT', '16mm')|replace('211410SPT', '14mm') }}</span>
              <span class="badge bg-primary rounded-pill">{{ count }}</span>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          
          <div class="mt-3">
            <small class="text-muted"><i class="fas fa-file me-1"></i>{{ customer.original_filename }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Order History -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-semibold"><i class="bi bi-clock-history me-2"></i>Order History</h6>
          <span class="badge bg-secondary">{{ orders|length }} Orders</span>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Order #</th>
                  <th>Items</th>
                  <th>Total Qty</th>
                </tr>
              </thead>
              <tbody>
                {% for order in orders %}
                  <tr>
                    <td>{{ order.ship_date[:10] }}</td>
                    <td>
                      <code>{{ order.order_number }}</code>
                      {% if order.source == 'shipstation' %}
                        <span class="badge bg-info text-dark ms-1" style="font-size:0.6em">API</span>
                      {% endif %}
                    </td>
                    <td>
                      <ul class="list-unstyled mb-0 small">
                        {% for item in order.items %}
                          <li>
                            <strong>{{ item.sku }}</strong>:
                            {{ item.quantity }}
                            <span class="text-muted"> (Lot: {{ item.lot }})</span>
                          </li>
                        {% endfor %}
                      </ul>
                    </td>
                    <td><strong>{{ order.total_qty }}</strong></td>
                  </tr>
                {% else %}
                  <tr>
                    <td colspan="4" class="text-center py-4 text-muted">
                      <i class="bi bi-inbox d-block mb-2" style="font-size: 1.5rem;"></i>
                      <small>No orders have been recorded for this customer yet.</small>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Section -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="mb-0 fw-semibold">Notes</h6>
          {% if matching_customer_id %}
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
              <i class="bi bi-plus-circle"></i> Add Note
            </button>
          {% else %}
            <small class="text-muted">Notes require a matching customer record</small>
          {% endif %}
        </div>
        <div class="card-body">
          {% if notes %}
            <div class="list-group list-group-flush">
              {% for n in notes %}
                <div class="list-group-item px-0 py-3 border-bottom note-item" data-note-id="{{ n.id }}">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="mb-1 note-text" data-note-id="{{ n.id }}">{{ n.note_text }}</div>
                      <div class="text-muted small">
                        <i class="bi bi-calendar3 me-1"></i>{{ (n.note_date or n.created_at)[:10] }}
                        {% if n.author %} · <i class="bi bi-person me-1"></i>{{ n.author }}{% endif %}
                        {% if n.updated_at and n.updated_at != n.created_at %}
                          · <span class="text-muted">(edited {{ n.updated_at[:10] }})</span>
                        {% endif %}
                      </div>
                    </div>
                    <div class="btn-group btn-group-sm ms-2">
                      <button class="btn btn-sm btn-outline-secondary edit-note-btn" data-note-id="{{ n.id }}" data-customer-id="{{ matching_customer_id }}" title="Edit note" aria-label="Edit note">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger delete-note-btn" data-note-id="{{ n.id }}" data-customer-id="{{ matching_customer_id }}" title="Delete note" aria-label="Delete note">
                        <i class="bi bi-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-3 text-muted">
              <i class="bi bi-inbox d-block mb-2" style="font-size: 1.5rem;"></i>
              {% if matching_customer_id %}
                <small>No notes yet. Click "Add Note" to create one.</small>
              {% else %}
                <small>Notes are not available. This customer record needs to be linked to a customer in the customers table.</small>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Note Modal -->
{% if matching_customer_id %}
<div class="modal fade" id="addNoteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="{{ url_for('admin_customer_profile', cust_id=customer.id) }}">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Customer</label>
            <input type="text" class="form-control" value="{{ customer.fields.get('Facility Name', 'Unknown') }}" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Note Date <span class="text-muted">(default: today)</span></label>
            <input type="date" name="note_date" class="form-control" id="noteDate" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Note Text <span class="text-danger">*</span></label>
            <textarea name="note_text" class="form-control" rows="4" required placeholder="Enter note text..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Note</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
function exportCustomerData() {
    const customerId = {{ customer.id }};
    const customerName = '{{ customer.fields.get("Facility Name", "Unknown") }}'.replace(/[^a-zA-Z0-9]/g, '_');
    
    // Create CSV export
    let csv = 'Date,Order Number,SKU,Quantity,Lot,Source\n';
    {% for order in orders %}
      {% for item in order.items %}
        csv += '{{ order.ship_date[:10] if order.ship_date else "Unknown" }},';
        csv += '{{ order.order_number }},';
        csv += '{{ item.sku }},';
        csv += '{{ item.quantity }},';
        csv += '{{ item.lot or "UNKNOWN" }},';
        csv += '{{ order.source or "Manual" }}\n';
      {% endfor %}
    {% endfor %}
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `${customerName}_orders_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function viewOrderHistory() {
    // Expand to show all orders
    alert('Full order history feature coming soon!');
}

function editCustomer() {
    alert('Customer editing feature coming soon!');
}

// Set today's date as default when modal opens
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('addNoteModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', function() {
      const today = new Date().toISOString().split('T')[0];
      const dateInput = document.getElementById('noteDate');
      if (dateInput) {
        dateInput.value = today;
      }
    });
  }
  
// Check for recent activity on page load
  {% if orders and orders[0].ship_date %}
  const lastOrderDate = new Date('{{ orders[0].ship_date }}');
  const now = new Date();
  const daysSince = Math.floor((now - lastOrderDate) / (1000 * 60 * 60 * 24));
  
  if (daysSince <= 30) {
    const alert = document.getElementById('recentActivityAlert');
    const message = document.getElementById('lastOrderMessage');
    if (alert && message) {
      message.textContent = `Last order was ${daysSince} days ago ({{ orders[0].ship_date|format_date }})`;
      alert.style.display = 'flex';
    }
  }
  {% endif %}
});
</script>
{% endblock %}
