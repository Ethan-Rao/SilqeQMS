{% extends "base.html" %}

{% block title %}Customer Database – eQMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1 class="h3 mb-1">Customer Database</h1>
    <p class="text-muted mb-0 small">{{ customers|length }} customers</p>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('admin_sales_dashboard') }}">
      <i class="bi bi-speedometer2 me-1"></i> Sales Dashboard
    </a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-3">
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-funnel me-2"></i>Search / Filter</h6>
      </div>
      <div class="card-body">
        <form method="get">
          <div class="mb-3">
            <label class="form-label">Name / Key</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input class="form-control" name="q" value="{{ (filters.q if filters else '') or '' }}" placeholder="Facility name or company key">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">State</label>
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-geo"></i></span>
              <input class="form-control" name="state" value="{{ (filters.state if filters else '') or '' }}" placeholder="CA">
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Rep</label>
            <select class="form-select" name="rep_id">
              <option value="">(any)</option>
              {% for r in all_reps or [] %}
                <option value="{{ r.id }}" {% if filters and filters.rep_id == r.id %}selected{% endif %}>{{ r.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-primary" type="submit">Apply</button>
            <a class="btn btn-outline-secondary" href="{{ url_for('admin_customers') }}">Clear</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-9">
    <div class="card shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h6 class="mb-0 fw-semibold"><i class="bi bi-people me-2"></i>Customers</h6>
        <span class="badge bg-secondary">{{ customers|length }} total</span>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm align-middle table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Facility</th>
            <th>City/State</th>
            <th>Recent Orders</th>
            <th>Primary Rep</th>
            <th>Assigned Reps</th>
            <th>Notes</th>
            <th style="width: 120px;">Action</th>
          </tr>
        </thead>
        <tbody>
          {% for c in customers %}
            <tr>
              <td>
                <strong>{{ c.facility_name or c.company_key }}</strong>
                <div class="text-muted small">{{ c.company_key }}</div>
              </td>
              <td>
                <span class="small text-nowrap">{{ (c.city or '') }}{% if c.city and c.state %}, {% endif %}{{ (c.state or '') }}</span>
              </td>
              <td>
                {% set ro = c.recent_orders or [] %}
                {% if ro %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#orders-{{ c.id }}" aria-expanded="false" aria-controls="orders-{{ c.id }}">
                    <i class="bi bi-chevron-down"></i> View <span class="text-muted">({{ ro|length }})</span>
                  </button>
                {% else %}
                  <span class="text-muted small">0</span>
                {% endif %}
              </td>
              <td>
                <span class="small">{{ c.primary_rep_name or '-' }}</span>
              </td>
              <td>
                {% if c.assigned_reps %}
                  {% for r in c.assigned_reps %}
                    <span class="badge {% if r.is_primary %}bg-primary{% else %}bg-secondary{% endif %}">{{ r.name }}</span>
                  {% endfor %}
                {% else %}
                  <span class="text-muted small">-</span>
                {% endif %}
              </td>
              <td>
                {% if c.note_count and c.note_count > 0 %}
                <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="modal" data-bs-target="#viewNotesModal" 
                        data-customer-id="{{ c.id }}" 
                        data-customer-name="{{ c.facility_name or c.company_key }}"
                        data-note-count="{{ c.note_count or 0 }}"
                        aria-label="View {{ c.note_count }} note{{ 's' if c.note_count != 1 else '' }} for {{ c.facility_name or c.company_key }}">
                  <i class="bi bi-sticky" aria-hidden="true"></i> View Notes ({{ c.note_count }})
                </button>
                {% else %}
                <span class="text-muted small">No notes</span>
                {% endif %}
              </td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin_customer_crm_profile', customer_id=c.id) }}">Open</a>
              </td>
            </tr>

            {% set ro = c.recent_orders or [] %}
            {% if ro %}
              <tr class="bg-light">
                <td colspan="7" class="p-0">
                  <div class="collapse" id="orders-{{ c.id }}">
                    <div class="p-2">
                      <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle mb-0">
                          <thead class="table-light">
                            <tr>
                              <th style="width: 110px;">Ship Date</th>
                              <th style="width: 180px;">Order #</th>
                              <th style="width: 90px;">Units</th>
                              <th>SKUs</th>
                              <th style="width: 130px;">Source</th>
                              <th style="width: 140px;">Primary Rep</th>
                            </tr>
                          </thead>
                          <tbody>
                            {% for o in ro %}
                              <tr>
                                <td class="small">{{ o.first_ship_date or '-' }}</td>
                                <td class="small">
                                  <a href="{{ url_for('admin_distribution_log', customer_id=c.id, order_group=o.order_group) }}">{{ o.order_number or o.order_group }}</a>
                                </td>
                                <td class="small"><span class="badge bg-secondary">{{ o.total_units or 0 }}</span></td>
                                <td class="small">{{ o.sku_summary or '-' }}</td>
                                <td class="small">{{ o.source_label or '-' }}</td>
                                <td class="small">{{ c.primary_rep_name or '-' }}</td>
                              </tr>
                            {% endfor %}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            {% endif %}
          {% else %}
            <tr>
              <td colspan="7" class="text-center py-4 text-muted">
                <i class="bi bi-people d-block mb-2" style="font-size: 1.5rem;"></i>
                <small>No customers found. Try adjusting your search filters.</small>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- View Notes Modal -->
<div class="modal fade" id="viewNotesModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Customer Notes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <strong id="viewNotesCustomerName"></strong>
        </div>
        <div id="viewNotesContent" class="notes-section">
          <div class="text-center py-4 text-muted">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
            Loading notes...
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a id="viewNotesAddNoteLink" href="#" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Add Note
        </a>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('viewNotesModal');
    if (modal) {
      modal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const customerId = button.getAttribute('data-customer-id');
        const customerName = button.getAttribute('data-customer-name');
        const noteCount = parseInt(button.getAttribute('data-note-count') || '0');
        
        document.getElementById('viewNotesCustomerName').textContent = customerName || 'Unknown Customer';
        document.getElementById('viewNotesAddNoteLink').href = '/admin/customer/' + customerId + '/crm';
        
        // Load notes via AJAX
        const contentDiv = document.getElementById('viewNotesContent');
        contentDiv.innerHTML = '<div class="text-center py-4 text-muted"><div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading notes...</div>';
        
        fetch('/admin/customer/' + customerId + '/notes/json')
          .then(response => response.json())
          .then(data => {
            if (data.notes && data.notes.length > 0) {
              let html = '<div class="list-group list-group-flush">';
              data.notes.forEach(function(note) {
                html += '<div class="list-group-item px-0 py-3 border-bottom note-item">';
                html += '<div class="note-text mb-2">' + escapeHtml(note.note_text) + '</div>';
                html += '<div class="note-meta text-muted small">';
                html += '<i class="bi bi-calendar3 me-1"></i>' + (note.note_date || note.created_at || '').substring(0, 10);
                if (note.author) {
                  html += ' · <i class="bi bi-person me-1"></i>' + escapeHtml(note.author);
                }
                if (note.updated_at && note.updated_at !== note.created_at) {
                  html += ' · <span class="text-muted">(edited ' + note.updated_at.substring(0, 10) + ')</span>';
                }
                html += '</div></div>';
              });
              html += '</div>';
              contentDiv.innerHTML = html;
            } else {
              contentDiv.innerHTML = '<div class="text-center py-4 text-muted"><i class="bi bi-inbox d-block mb-2" style="font-size: 1.5rem;"></i><small>No notes yet.</small></div>';
            }
          })
          .catch(error => {
            console.error('Error loading notes:', error);
            contentDiv.innerHTML = '<div class="alert alert-warning">Error loading notes. Please try again.</div>';
          });
      });
    }
  });
  
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
</script>
{% endblock %}
